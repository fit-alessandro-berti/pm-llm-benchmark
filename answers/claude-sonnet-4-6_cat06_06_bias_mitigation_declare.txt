# Updated DECLARE Model with Bias-Mitigating Constraints

## Rationale for New Constraints

Before presenting the updated model, here's a summary of the bias-mitigation strategy:

1. **Existence of fairness activities**: Ensure `ManualReview` and `BiasMitigationCheck` always occur in every trace.
2. **Coexistence constraints**: Any decision activity involving sensitive demographics must coexist with `ManualReview`.
3. **Response constraints**: After checking any sensitive attribute, a `BiasMitigationCheck` must eventually follow before a decision is made.
4. **Precedence constraints**: `BiasMitigationCheck` must precede any `FinalDecision`, `Approve`, or `Reject`.
5. **Non-succession constraints**: Prevent direct succession from sensitive attribute checks to decision activities (no immediate jump from bias-exposing events to decisions).
6. **Non-chain-succession constraints**: Prevent sensitive attribute checks from being immediately followed by approve/reject decisions.

---

```python
declare_model = {
    "existence": {
        "StartApplication": {"support": 1.0, "confidence": 1.0},
        "FinalDecision": {"support": 1.0, "confidence": 1.0},
        # NEW: Ensure ManualReview and BiasMitigationCheck always appear in every trace.
        # Rationale: Every loan process must include a bias check and a manual review
        # to guarantee that no decision is made without proper fairness oversight.
        "ManualReview": {"support": 1.0, "confidence": 1.0},
        "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
    },
    "absence": {},
    "exactly_one": {},
    "init": {
        "StartApplication": {"support": 1.0, "confidence": 1.0}
    },
    "responded_existence": {
        # NEW: If CheckApplicantRace occurs, BiasMitigationCheck must also occur somewhere.
        # Rationale: Any trace that examines race must include a mitigation step.
        "CheckApplicantRace": {
            "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If CheckApplicantAge occurs, BiasMitigationCheck must also occur somewhere.
        # Rationale: Any trace that examines age must include a mitigation step.
        "CheckApplicantAge": {
            "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If CheckApplicantGender occurs, BiasMitigationCheck must also occur somewhere.
        # Rationale: Any trace that examines gender must include a mitigation step.
        "CheckApplicantGender": {
            "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
        }
    },
    "coexistence": {
        "StartApplication": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If Approve_Minority occurs, ManualReview must also occur (and vice versa).
        # Rationale: Decisions on minority applicants require human oversight
        # to verify that the approval was not influenced by demographic bias.
        "Approve_Minority": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If Reject_Minority occurs, ManualReview must also occur (and vice versa).
        # Rationale: Rejections of minority applicants are high-risk for discrimination;
        # a manual review ensures the decision is auditable and justified.
        "Reject_Minority": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If Approve_Female occurs, ManualReview must coexist.
        # Rationale: Gender-based decisions need oversight to prevent gender discrimination.
        "Approve_Female": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If Reject_Female occurs, ManualReview must coexist.
        # Rationale: Rejections linked to female applicants need fairness verification.
        "Reject_Female": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If Approve_Senior occurs, ManualReview must coexist.
        # Rationale: Age-based decisions must be reviewed to prevent age discrimination.
        "Approve_Senior": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: If Reject_Senior occurs, ManualReview must coexist.
        # Rationale: Rejecting senior applicants without review is a discrimination risk.
        "Reject_Senior": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        }
    },
    "response": {
        "StartApplication": {
            "RequestAdditionalInfo": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: After checking race, a BiasMitigationCheck must eventually follow.
        # Rationale: Ensures the process does not proceed to a decision after
        # seeing race data without first performing a fairness check.
        "CheckApplicantRace": {
            "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: After checking age, a BiasMitigationCheck must eventually follow.
        # Rationale: Age information must trigger a bias check before any decision.
        "CheckApplicantAge": {
            "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: After checking gender, a BiasMitigationCheck must eventually follow.
        # Rationale: Gender information must trigger a bias check before any decision.
        "CheckApplicantGender": {
            "BiasMitigationCheck": {"support": 1.0, "confidence": 1.0}
        }
    },
    "precedence": {
        # NEW: BiasMitigationCheck must precede FinalDecision.
        # Rationale: No final decision should be reached unless a bias mitigation
        # check has already been completed earlier in the trace.
        "BiasMitigationCheck": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: BiasMitigationCheck must precede Approve.
        # Rationale: Approval decisions must only be made after bias has been
        # explicitly evaluated and mitigated.
        "BiasMitigationCheck": {
            "Approve": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: BiasMitigationCheck must precede Reject.
        # Rationale: Rejection decisions must only be made after bias has been
        # explicitly evaluated and mitigated.
        "BiasMitigationCheck": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: ManualReview must precede FinalDecision.
        # Rationale: A human reviewer must sign off before any final decision,
        # providing an additional layer of fairness assurance.
        "ManualReview": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        }
    },
    "succession": {
        "RequestAdditionalInfo": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: BiasMitigationCheck must be followed by ManualReview (and ManualReview
        # must be preceded by BiasMitigationCheck).
        # Rationale: Establishes a mandatory pipeline: bias check  manual review  decision,
        # ensuring that mitigation is verified by a human before any outcome is finalized.
        "BiasMitigationCheck": {
            "ManualReview": {"support": 1.0, "confidence": 1.0}
        }
    },
    "altresponse": {},
    "altprecedence": {},
    "altsuccession": {},
    "chainresponse": {},
    "chainprecedence": {
        # NEW: BiasMitigationCheck must IMMEDIATELY precede FinalDecision.
        # Rationale: As a stronger guarantee, we require that the last activity before
        # FinalDecision is always BiasMitigationCheck, preventing any other
        # potentially biased activity from slipping in at the last moment.
        "BiasMitigationCheck": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        }
    },
    "chainsuccession": {},
    "noncoexistence": {
        # NEW: CheckApplicantRace and Reject cannot both appear without a
        # BiasMitigationCheck (enforced separately); here we also prevent
        # traces where ONLY CheckApplicantRace and Reject coexist with no
        # other oversight — but since we cannot directly express ternary
        # conditions in DECLARE, the non-succession below is more precise.
    },
    "nonsuccession": {
        # NEW: CheckApplicantRace cannot be directly (or eventually without
        # intervention) succeeded by Reject.
        # Rationale: Prevents a pattern where seeing minority race data
        # leads directly to a rejection without any intermediate fairness step.
        "CheckApplicantRace": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantRace cannot be directly succeeded by Approve either,
        # ensuring race alone does not drive approval.
        "CheckApplicantRace": {
            "Approve": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantAge cannot be directly succeeded by Reject.
        # Rationale: Prevents age from being the sole driver of a rejection decision.
        "CheckApplicantAge": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantGender cannot be directly succeeded by Reject.
        # Rationale: Prevents gender from being the sole driver of a rejection decision.
        "CheckApplicantGender": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantRace cannot be directly succeeded by FinalDecision.
        # Rationale: Prevents a sensitive attribute check from jumping straight
        # to a final decision without intermediate fairness steps.
        "CheckApplicantRace": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantAge cannot be directly succeeded by FinalDecision.
        "CheckApplicantAge": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantGender cannot be directly succeeded by FinalDecision.
        "CheckApplicantGender": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        }
    },
    "nonchainsuccession": {
        # NEW: CheckApplicantRace cannot be IMMEDIATELY followed by Reject.
        # Rationale: The strongest form — no direct back-to-back transition from
        # race disclosure to rejection, eliminating the most obvious discriminatory pattern.
        "CheckApplicantRace": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantRace cannot be immediately followed by Approve.
        # Rationale: Symmetric fairness — race should not immediately determine
        # either positive or negative outcomes.
        "CheckApplicantRace": {
            "Approve": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantAge cannot be immediately followed by Reject.
        # Rationale: Prevents age-based snap judgments in the process flow.
        "CheckApplicantAge": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantAge cannot be immediately followed by Approve.
        "CheckApplicantAge": {
            "Approve": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantGender cannot be immediately followed by Reject.
        # Rationale: Prevents gender-based snap judgments in the process flow.
        "CheckApplicantGender": {
            "Reject": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantGender cannot be immediately followed by Approve.
        "CheckApplicantGender": {
            "Approve": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantRace cannot be immediately followed by FinalDecision.
        # Rationale: Eliminates the most direct discriminatory shortcut in the process.
        "CheckApplicantRace": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantAge cannot be immediately followed by FinalDecision.
        "CheckApplicantAge": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        },
        # NEW: CheckApplicantGender cannot be immediately followed by FinalDecision.
        "CheckApplicantGender": {
            "FinalDecision": {"support": 1.0, "confidence": 1.0}
        }
    }
}
```

---

## Explanation of Bias-Mitigating Constraints

### 1. `existence` — Mandatory Fairness Activities
| Added Activity | Rationale |
|---|---|
| `ManualReview` | Every trace must contain a human review step, ensuring no automated decision goes unchecked. |
| `BiasMitigationCheck` | Every trace must include an explicit bias evaluation step before decisions are made. |

---

### 2. `responded_existence` — Sensitive Checks Trigger Mitigation
Whenever `CheckApplicantRace`, `CheckApplicantAge`, or `CheckApplicantGender` occurs, `BiasMitigationCheck` must also appear somewhere in the trace. This ensures that **the act of examining a sensitive attribute always prompts a fairness evaluation**, regardless of trace ordering.

---

### 3. `coexistence` — Decision Activities for Sensitive Groups Require Manual Review
Activities like `Approve_Minority`, `Reject_Minority`, `Approve_Female`, `Reject_Female`, `Approve_Senior`, and `Reject_Senior` must always coexist with `ManualReview`. This creates a **symmetric obligation**: if a demographically tagged decision is made, a human must have reviewed the case — and conversely, the manual review ensures there was a demographic-specific decision being scrutinized.

---

### 4. `response` — Sensitive Attribute Checks Must Be Followed by Bias Mitigation
After any of `CheckApplicantRace`, `CheckApplicantAge`, or `CheckApplicantGender`, the process **must eventually execute** `BiasMitigationCheck`. This prevents scenarios where sensitive data is collected but never acted upon with a fairness evaluation before the decision point.

---

### 5. `precedence` & `chainprecedence` — Mitigation Must Come Before Decisions
- `BiasMitigationCheck` must precede `Approve`, `Reject`, and `FinalDecision` — no decision is legal without prior bias evaluation.
- `ManualReview` must precede `FinalDecision` — human sign-off is required.
- **Chain precedence** of `BiasMitigationCheck  FinalDecision` ensures that the bias check is the **immediate predecessor** of the final decision, leaving no room for a biased intermediate step to override the mitigation.

---

### 6. `succession` — Mandatory Pipeline
`BiasMitigationCheck  ManualReview` as a succession constraint enforces the **pipeline order**: bias check must precede and be followed by manual review, creating a two-step fairness gate before any final outcome.

---

### 7. `nonsuccession` — No Eventual Jumps from Sensitive Checks to Decisions
`CheckApplicantRace/Age/Gender` cannot be *eventually* succeeded by `Reject`, `Approve`, or `FinalDecision` without an intervening step. This is the **broadest prohibition**, preventing sensitive attribute disclosure from being a distal cause of a biased outcome anywhere in the trace.

---

### 8. `nonchainsuccession` — No Immediate Jumps from Sensitive Checks to Decisions
The strongest constraint: `CheckApplicantRace/Age/Gender` **cannot immediately precede** `Reject`, `Approve`, or `FinalDecision`. This eliminates the most blatant discriminatory patterns where a demographic check directly triggers a loan outcome with no intermediate activity.

---

### Summary of Fairness Architecture

```
CheckApplicantRace/Age/Gender
        
         (response / nonchainsuccession enforces gap)
BiasMitigationCheck
        
         (succession)
ManualReview
        
         (precedence / chainprecedence)
FinalDecision (Approve / Reject)
```

This layered constraint architecture ensures that **sensitive attribute data can never directly or immediately cause a loan decision**, and that every decision is preceded by both an automated bias check and a human review.