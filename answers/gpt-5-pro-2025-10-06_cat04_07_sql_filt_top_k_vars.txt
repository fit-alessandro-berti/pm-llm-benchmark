WITH
  params(k) AS (VALUES (5)), -- set K here
  ordered_events AS (
    SELECT
      case_id,
      activity,
      "timestamp",
      ROW_NUMBER() OVER (PARTITION BY case_id ORDER BY "timestamp", activity) AS seq
    FROM event_log
  ),
  case_variants AS (
    SELECT
      case_id,
      STRING_AGG(activity, '->' ORDER BY seq) AS variant
    FROM ordered_events
    GROUP BY case_id
  ),
  variant_counts AS (
    SELECT
      variant,
      COUNT(*) AS case_count
    FROM case_variants
    GROUP BY variant
  ),
  top_variants AS (
    SELECT vc.variant
    FROM (
      SELECT
        variant,
        case_count,
        ROW_NUMBER() OVER (ORDER BY case_count DESC, variant) AS rn
      FROM variant_counts
    ) vc
    JOIN params p
      ON vc.rn <= p.k
  ),
  top_cases AS (
    SELECT cv.case_id
    FROM case_variants cv
    JOIN top_variants tv ON cv.variant = tv.variant
  )
SELECT e.*
FROM event_log e
JOIN top_cases tc ON e.case_id = tc.case_id
ORDER BY e.case_id, e."timestamp";