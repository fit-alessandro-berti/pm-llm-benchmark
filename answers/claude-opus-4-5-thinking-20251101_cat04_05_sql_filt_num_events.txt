# DuckDB SQL Query: Filtering Cases by Event Count

## Solution

Here are multiple approaches to solve this problem, from most elegant (DuckDB-specific) to most portable:

### Approach 1: Using `QUALIFY` Clause (DuckDB Preferred)

```sql
SELECT *
FROM event_log
QUALIFY COUNT(*) OVER (PARTITION BY case_id) <= 6;
```

This is the most concise solution leveraging DuckDB's support for the `QUALIFY` clause, which filters on window function results.

---

### Approach 2: Using a Window Function with Subquery

```sql
SELECT 
    case_id,
    activity,
    timestamp
FROM (
    SELECT 
        *,
        COUNT(*) OVER (PARTITION BY case_id) AS case_event_count
    FROM event_log
) AS enriched_log
WHERE case_event_count <= 6;
```

---

### Approach 3: Using a Subquery with `IN`

```sql
SELECT *
FROM event_log
WHERE case_id IN (
    SELECT case_id
    FROM event_log
    GROUP BY case_id
    HAVING COUNT(*) <= 6
);
```

---

### Approach 4: Using a CTE with `JOIN`

```sql
WITH valid_cases AS (
    SELECT case_id
    FROM event_log
    GROUP BY case_id
    HAVING COUNT(*) <= 6
)
SELECT e.*
FROM event_log e
INNER JOIN valid_cases v 
    ON e.case_id = v.case_id;
```

---

## How It Works

```

                    event_log table                      

  case_id      activity     timestamp                  

                                                        
                                                        
                        
           Step 1: Count events per                    
           case_id using window function               
           or GROUP BY                                 
                        
                                                        
                                                        
                        
           Step 2: Filter to keep only                 
           cases where count <= 6                      
                        
                                                        
                                                        
                        
           Step 3: Return all events                   
           from qualifying cases                       
                        

```

## Recommendation

| Approach | Pros | Best For |
|----------|------|----------|
| **QUALIFY** | Most concise, single table scan | DuckDB-specific projects |
| **Window + Subquery** | Clear logic, portable | General use |
| **IN Subquery** | Simple to understand | Quick queries |
| **CTE + JOIN** | Most readable, maintainable | Complex pipelines |

For **DuckDB specifically**, I recommend **Approach 1** (`QUALIFY`) as it's the most efficient and idiomatic solution.