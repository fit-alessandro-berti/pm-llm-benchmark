## 1. Identifying Instance-Spanning Constraints and Their Impact

### 1.1 General Approach with the Event Log

From the log you have:

- Case attributes: `Order Type`, `Destination Region`, `Requires Cold Packing`, `Hazardous Material`
- Activity lifecycle: `Timestamp Type` (START/COMPLETE)
- Resources: pickers, packing stations, QC staff, batch IDs for shipping

Using process mining + log enrichment:

1. **Reconstruct activity durations and waiting times per case:**
   - For each case and activity:
     - `activity_duration = COMPLETE - START`
     - `sojourn_time = end_of_activity - start_of_activity` (if you treat also waiting inside activity).
   - For each transition between activities (e.g., `Item Picking.COMPLETE`  `Packing.START`):
     - `waiting_time_between_activities = Packing.START - Item Picking.COMPLETE`.

2. **Reconstruct resource timelines:**
   - For each resource (e.g., Station C2), build a time-sequence of all intervals `[START, COMPLETE]` where that resource is busy.
   - From this, infer queues: overlapping demands for the same resource.

3. **Tag each time interval with relevant attributes:**
   - Is the case Express or Standard?
   - Does it require cold packing?
   - Is it hazardous?
   - Which batch / region?

This gives the basis to link each delay to a specific instance-spanning constraint.

---

### 1.2 Shared Cold-Packing Stations (Limited Cold Stations)

**Identification:**

- Filter log on `Activity = Packing` AND `Requires Cold Packing = TRUE`.
- Among those, isolate events where `Resource`  {Cold stations: C1…C5}.
- Build a **resource Gantt chart** for cold stations: for each station, intervals when it is busy.
- For each cold-packing case, compute:
  - Waiting time from previous activity completion (e.g., picking complete) to `Packing.START`.
  - Queue length at its `Packing.START`: number of other cold-packing orders for which `Packing` STARTED earlier but not yet COMPLETE (i.e., in service) plus those already waiting (constructed via event sequencing).

**Metrics:**

- `Avg / median / percentile waiting time before Cold Packing` for cold orders.
- `Resource utilization` per cold station (busy time / available time).
- `Average queue length` and `max queue length` at cold packing.
- `Frequency of station idleness while cold orders wait` (indicates scheduling/inflexibility).

**Impact quantification:**

- Compare **lead time of cold orders vs non-cold orders**, controlling for other factors (express/region).
- Compute contribution of cold packing waiting to total throughput time for cold orders:
  - fraction = `waiting_for_cold_packing / end-to-end_time`.

---

### 1.3 Shipping Batches (Batching Before Label Generation)

**Identification:**

- Filter `Activity = Shipping Label Gen.` and use the `Resource` field indicating batch ID (e.g., `System (Batch B1)`).
- Group cases by `Batch ID` and `Destination Region`.
- For each case:
  - `ready_for_batch_time = Quality Check.COMPLETE` (or last pre-batching activity).
  - `batch_start_time = Shipping Label Gen.START` or COMPLETE time (depending on when batching logically occurs).
  - `batch_waiting_time = batch_start_time - ready_for_batch_time`.

**Metrics:**

For each region and batch policy:

- `Average batch waiting time` per order.
- `Distribution of batch sizes` (#orders per batch).
- `Average time between first order in batch ready` and `last order in batch ready`.
- `Batching-induced idle time`: case’s ready time minus its earliest possible shipping cut-off if it were shipped alone.
- `Share of total case cycle time attributable to batching wait`.

**Impact quantification:**

- Compare overall cycle time with and without batching wait:
  - “What-if” metric: `cycle_time_without_batching = cycle_time - batch_waiting_time`.
- Identify regions / times-of-day where batching causes longest delays.

---

### 1.4 Priority Handling for Express Orders

**Identification:**

- Mark all `Order Type = Express`.
- For each shared resource type (packing stations, QC, pickers), trace **preemption events**:
  - A Standard order using a resource when an Express order arrives and subsequently the standard order is paused or queued behind express.
  - In logs, pausing might appear as:
    - Split activity segments, or
    - A gap between START and COMPLETE with an overlapping express activity on same resource, or
    - Standard order waiting to start although resource is idle for it (tied-up by policy for incoming express orders).

If the log doesn’t explicitly encode preemption segments, you approximate:

- At each Express `Packing.START`, check whether:
  - Resource was idle at that time (no preemption), or
  - Resource was already busy with another case and that case’s activity duration is abnormally extended (suggesting interruption), or
  - Another case had just completed earlier than its historical median (suggesting push-out).

**Metrics:**

- For Express orders:
  - `End-to-end lead time`, `waiting_time_at_each_step`.
- For Standard orders (especially at shared steps):
  - `Extra waiting time when Express traffic is high`:
    - Regress waiting times against `#express_orders_in_system` to quantify correlation.
- Preemption/priority impact:
  - `Average delay added to Standard orders at Packing due to Express arrivals`.
  - `Resource utilization fraction spent on Express vs Standard`.
  - `Probability that a Standard order experiences at least one preemption or “jumped queue” event`.

**Impact quantification:**

- Simulate or infer “no-priority” baseline by comparing:
  - Periods with almost no express orders vs periods with many.
  - Or use queueing model fitting to estimate extra waiting due to priority.

---

### 1.5 Hazardous Material Limits (Max 10 Simultaneous in Packing + QC)

**Identification:**

- Filter log for activities `Packing` and `Quality Check` AND `Hazardous Material = TRUE`.
- Build a timeline: for each hazardous order in these activities, interval `[START, COMPLETE]`.
- At fine time resolution (e.g., per minute), count how many hazardous orders are in `Packing` or `QC` simultaneously.

- Identify:
  - Periods where this number hits the limit (10).
  - For hazardous orders ready to start packing/QC but **not started**, check if the number in progress is 10 at that time  likely blocked by regulation.

**Metrics:**

- `Time-at-limit`: fraction of time the system is exactly at 10 hazardous orders in P+QC.
- `Average waiting time before Packing/QC` for hazardous vs non-hazardous orders.
- `# of hazardous orders waiting due to regulation`:
  - For each hazardous order, check if at its desired start time (previous activity completion) the hazard-in-process count is 10; measure wait until it drops below 10.
- `Throughput of hazardous orders` vs non-hazardous.

**Impact quantification:**

- Contribution of regulatory waiting to hazardous orders’ cycle time.
- If overall facility throughput decreases when hazardous load is high (bottleneck at P+QC).

---

### 1.6 Separating Within-Instance vs Between-Instance Waiting

To distinguish:

- **Within-instance problem:** Long processing time of the activity itself (e.g., slow packing).
- **Between-instance problem:** The case is ready but cannot start due to resource / batch / regulatory constraint.

Use:

1. **Explicit decomposition of time:**

   For each activity in each case:

   - `Flow waiting time to start = Activity.START - PreviousActivity.COMPLETE`  
     (pure waiting between activities)
   - `Processing time = Activity.COMPLETE - Activity.START`.

   Between-instance constraints mainly affect the first component.

2. **Resource-state-based classification:**

   For each waiting interval before an activity:

   - Check resource availability state:
     - If there is an available suitable resource (e.g., free station) and hazard limit not reached, then delay is likely **within-instance** (e.g., scheduling policy, handover delay, data entry).
     - If all resources are busy OR hazard limit is maxed, then delay is due to **between-instance** (resource contention or regulation).
   - For batching:
     - If the next activity is `Shipping Label Gen.`, and system is technically able to start it (system resource), but batch start is not triggered until other cases arrive  classify as **batch-induced between-instance waiting**.

3. **Statistical comparison:**

   - Compare waiting times during high vs low system load.
   - If waiting strongly correlates with:
     - `#orders in queue for that resource`,
     - resource utilization,
     - #hazardous-in-process,
   then it’s largely between-instance.

---

## 2. Analyzing Constraint Interactions

### 2.1 Express + Cold-Packing Stations

- Express orders that require cold packing:
  - Are routed to limited cold stations (bottleneck).
  - Have priority over standard cold orders, potentially preempting them.
- Effects:
  - Standard cold orders experience increased waiting and variance.
  - You may see high utilization of cold stations coupled with long queues.
- Trade-off:
  - Improving express lead time may disproportionately worsen delay for standard cold orders, potentially affecting SLA for standard delivery windows.

### 2.2 Batching + Hazardous Material Limits

- If multiple hazardous orders to the same region arrive:
  - They might all move towards P/QC around similar times.
  - The 10-order limit may cause hazardous orders to be held back in earlier steps, delaying their “ready-for-batch” times.
- Interplay with batching:
  - A batch destined to a region with many hazardous orders might:
    - Form slowly because some hazardous orders are blocked by the limit.
    - Or form quickly but then later hazardous orders for same region must wait for next batch, increasing total flow time.
- Risk:
  - Attempting to clear hazardous orders quickly to form a batch may repeatedly hit the regulatory limit, creating upstream queues.

### 2.3 Priority Handling + Hazardous Limits

- Express hazardous orders get priority at Packing/QC, but **they still count towards the max-10 limit**.
- Very express-heavy periods:
  - Could exhaust the hazardous capacity (10) with mostly express orders, forcing standard hazardous orders to wait even when stations are physically free.
- Policy question:
  - Do we reserve some hazardous slots for standard orders (to avoid starvation)?  
  - Or use a time-slicing scheme?

### 2.4 Cold-Packing + Batching

- Cold-packed orders may have shorter viability intervals; they **shouldn’t wait too long in batches**.
- If batch formation waits for additional orders in the same region:
  - Cold express orders may breach cold-chain timing constraints or drag down on-time delivery metrics.
- There may be a case for:
  - Separate batching logic for cold orders vs normal orders in the same region, or
  - Smaller batch sizes / faster batch triggers for cold express orders.

### 2.5 Why Understanding Interactions Matters

- **Local optimization is dangerous**:
  - Simply adding more batches to reduce batching delay might overload packing or QC, hitting hazardous limits.
  - Giving unlimited priority to express may cause extreme delays for standard orders and underutilized downstream capacity due to uneven flow.
- Interactions define:
  - Where to add capacity (cold vs standard stations).
  - How to set **priority rules** that remain compliant (hazardous limit) and fair (avoid starvation).
  - How to vary policies by **time of day** or **load profile**.

Process mining helps you see combined effects:
- Compare KPIs by time segments where multiple constraints are simultaneously tight (e.g., cold station >90% utilization AND hazardous count at limit AND high express traffic).

---

## 3. Constraint-Aware Optimization Strategies

Below are three concrete, data-driven strategies. They can be used independently or combined.

---

### Strategy 1: Dynamic Cold-Packing Allocation & Time-Window Priority

**Constraints addressed:**  
- Shared cold-packing stations  
- Priority handling (express vs standard)  
- Indirectly impacts batching (by stabilizing upstream cold process)

#### 3.1.1 Proposed Changes

1. **Load-based station assignment:**
   - Use process mining to quantify:
     - Arrival patterns of cold orders over day/week.
     - Typical processing times.
   - Introduce a scheduling rule:
     - Maintain a **small reserved capacity** at cold stations for express cold orders (e.g., one station or a percentage of time), rather than absolute preemption.
     - Standard cold orders continue on other stations; express uses reserved capacity first.
   - If express volume is low, reserved capacity can be backfilled with standard cold orders.

2. **Priority within time windows instead of immediate preemption:**
   - Replace “preempt immediately” with “express must start within X minutes of becoming ready”.
   - If a standard order is in progress and near completion, allow it to finish; only preempt if predicted remaining time exceeds X.
   - Use historical `Packing` duration distributions from logs to estimate remaining time.

3. **Predictive arrival smoothing:**
   - Predict peak cold order arrivals using historical patterns.
   - During predicted peaks, pre-assign more staff to cold-packing or temporarily convert one standard station to cold (if equipment permits) for a time block.

#### 3.1.2 Use of Data/Analysis

- From log:
  - Distribution of express vs standard cold orders by hour/day.
  - Empirical service-time distributions at each cold station.
  - Probability that an order overtakes another under current rules.

- Use this to:
  - Tune the express time window X.
  - Size reserved capacity (e.g., 20–30% of total cold capacity for express).

#### 3.1.3 Expected Outcomes

- Reduce excessive waiting for standard cold orders without compromising express SLA.
- Lower variance in cold order lead times.
- Improved utilization of cold stations (fewer idle periods reserved for express when none are present).
- Measurable via:
  - Reduced average and 90th-percentile waiting time for standard cold orders.
  - Maintain or improve on-time delivery for express cold orders.

---

### Strategy 2: Smart, Dynamic Batching Rules for Shipping

**Constraints addressed:**  
- Batching for shipping  
- Interacts with cold orders and hazardous orders

#### 3.2.1 Proposed Changes

1. **Dynamic batch triggers instead of fixed thresholds:**
   - Move from a simple “wait until N orders for region R” to a rule:
     - Trigger batch when earliest order in candidate batch has waited more than `T_max` minutes since QC completion, or the number of ready orders  `N_min`, whichever comes first.
   - Use region-specific `T_max` and `N_min` based on historical data:
     - E.g., near regions get smaller `T_max` because delays are more visible.

2. **Segregated batching for cold and express orders:**
   - For orders that are both express and cold:
     - Use smaller `N_min_express_cold` and shorter `T_max_express_cold`.
   - Optionally create dedicated “fast” micro-batches for express orders, shipped more frequently.

3. **Hazard-aware batching logic:**
   - When forming a batch for a region:
     - Do not wait on hazardous orders that are still blocked upstream (due to the 10-limit).
     - Instead, close the current batch with available safe orders when waiting longer would cause older cases to exceed acceptable wait thresholds.
   - Use logs to quantify typical time hazardous orders spend blocked, and adjust `T_max` so that batching does not amplify that delay.

#### 3.2.2 Use of Data/Analysis

- From log:
  - Batch composition stats: orders per batch, % cold, % express, % hazardous.
  - Wait time for the first vs last order in each batch.
  - Cost/time trade-offs of small vs large batches (shipping cost vs SLA).

- Fit models that show:
  - How increasing `N_min` decreases shipping cost but increases order cycle time.
  - Use this to pick region-specific optimal parameters.

#### 3.2.3 Expected Outcomes

- Reduced batching-induced waiting time, especially for express and cold orders.
- More predictable lead times (less extreme waits for the “unlucky first” in a batch).
- Still acceptable shipping cost due to region-wise tuning.
- Measurable via:
  - Lower `batch_waiting_time` percentiles.
  - Higher on-time delivery rates for regions with problematic batching.

---

### Strategy 3: Hazard-Aware Scheduling and Capacity Management

**Constraints addressed:**  
- Hazardous materials limit (max 10 in Packing+QC)  
- Interacts with priority and overall throughput

#### 3.3.1 Proposed Changes

1. **Hazard slots and time-slicing:**
   - Instead of letting hazardous orders flow arbitrarily until they hit the cap, define:
     - A target **hazard load profile**: e.g., 6–8 hazardous orders in P+QC most of the time, leaving buffer below the legal 10.
   - When hazard-in-process count is high (8):
     - Suspend new hazardous starts unless:
       - They are express and close to SLA breach, or
       - The risk of starvation is high (hazard waiting too long).
   - This buffer prevents frequent hard blocking at limit=10 and smooths flows.

2. **Dedicated hazard windows or resources:**
   - Allocate specific time windows or dedicated staff/lanes for hazardous packing/QC:
     - e.g., “hazard-heavy waves” at known arrival peaks.
   - Coordinate with upstream picking:
     - Slow down hazardous picking when downstream hazard pipeline is saturated.

3. **Priority mix policy for hazardous orders:**
   - Among hazardous orders, implement a mix:
     - Some slots reserved for express hazardous.
     - Some guaranteed for standard hazardous to avoid starvation.
   - Use log-based SLA analysis to set:
     - Maximum waiting time targets for standard hazardous orders.

#### 3.3.2 Use of Data/Analysis

- From log:
  - Time series of `hazard_in_process_count` in P+QC.
  - Distribution of waiting times before P/QC for hazardous vs non-hazardous.
  - When SLA breaches occur for hazardous orders.

- Use predictive models:
  - Forecast hazard inflow (arrivals per hour).
  - Use this to tune hazard windows and target levels.

#### 3.3.3 Expected Outcomes

- Fewer periods at the legal hazardous limit (10).
- Lower average waiting time and variance for hazardous orders.
- Reduced risk of regulatory non-compliance.
- Measurable via:
  - Lower time spent at limit=10.
  - Reduced share of cycle time attributable to regulatory waiting.

---

### Strategy 4 (Optional Extension): Minor Process Redesign / Decoupling

**Constraints addressed:**  
- All of the above, by decoupling bottleneck steps where feasible.

Examples:

- **Split QC into “pre-check” and “final check”**:
  - Pre-check can be done earlier while waiting for packing capacities.
  - Final QC closer to shipping, reducing time hazardous orders spend in counted steps.

- **Pre-assembly for cold orders**:
  - Do certain prep steps outside the cold station (e.g., boxing, documentation), so the cold station time is minimized.

These redesigns make limited resources more focused on their essential work, reducing contention.

---

## 4. Simulation and Validation

Before implementing, build **discrete-event simulation** models, informed by mined parameters.

### 4.1 Model Elements to Capture

1. **Process flow:**
   - Order Received  Picking  Packing  Quality Check  Shipping Label Gen.  Dispatch.

2. **Case attributes:**
   - Express vs Standard
   - Cold vs Non-cold
   - Hazardous vs Non-hazardous
   - Destination Region

3. **Resources:**
   - Number of pickers
   - Standard packing stations
   - Cold packing stations
   - QC staff
   - System/batch shipping

4. **Instance-spanning constraints:**
   - Cold station capacity (and priority rules from Strategy 1).
   - Batch formation logic (Strategy 2).
   - Hazardous limit of 10 across P+QC (Strategy 3).
   - Priority for express orders (including possible preemption rules).

5. **Arrivals and service times:**
   - Use distributions fitted from event log:
     - Interarrival times per order type and per region.
     - Activity duration distributions (per additional attributes when relevant).

### 4.2 Scenarios to Simulate

- **Baseline:** current policies as inferred from logs.
- **Strategy variants:**
  - Different express windows X and reserved cold capacity percentages.
  - Different batch rules: (N_min, T_max) per region; separate parameters for express and cold.
  - Different hazard thresholds and time slicing policies.

### 4.3 KPIs to Evaluate in Simulation

- End-to-end lead time distributions by:
  - Order Type (Express, Standard)
  - Cold vs Non-cold
  - Hazardous vs Non-hazardous
  - Region

- Resource KPIs:
  - Utilization per station type.
  - Queue length distributions per resource type.
  - Frequency of preemptions.

- Constraint-specific KPIs:
  - Time at hazardous limit=10.
  - Average wait due to batching.
  - Waiting for cold packing.

- SLA metrics:
  - % orders delivered within promised window per segment.

Compare simulated KPIs for baseline vs each strategy; choose configurations that yield best SLA improvements with acceptable resource and cost impacts.

---

## 5. Monitoring Post-Implementation

After rollout, continuous monitoring via process mining dashboards is essential.

### 5.1 Key Metrics and Dashboards

1. **End-to-End Performance Dashboard:**
   - Cycle time distributions segmented by:
     - Express/Standard
     - Cold/Non-cold
     - Hazardous/Non-hazardous
     - Region
   - On-time delivery rate vs SLA.

2. **Resource Contention Dashboard (Cold & Standard Packing):**
   - Utilization per packing station type.
   - Average/90th percentile waiting time to start Packing, per order segment.
   - Queue length over time for cold vs standard stations.
   - Rate of preemption events (if encoded) and impact on standard orders’ waiting.

3. **Batching Dashboard:**
   - Batch size distribution per region.
   - Average waiting time for Shipping Label Gen. by region and order type.
   - Time between first and last order ready in each batch (aging within batch).
   - Specific charts for express and cold orders to ensure batching rules are respected.

4. **Hazardous Materials Compliance Dashboard:**
   - Time series of concurrent hazardous orders in P+QC (per minute/hour).
   - % of time at hazardous count levels: 0–5, 6–8, 9, 10.
   - Waiting times of hazardous orders before P/QC.
   - Indicator of any violations (if count ever >10, should not happen).

5. **Load vs Performance Dashboard:**
   - Plots of incoming volume vs lead times (per day/hour).
   - Helps confirm that strategies scale and remain robust during peaks.

### 5.2 How to Track Effective Management of Constraints

- **Shared Cold-Packing:**
  - Trend of average and 90th percentile waiting for cold packing over time.
  - Balance of utilization vs queue; check if peaks are shorter and less severe.
  - Compare pre/post implementation for express vs standard cold orders.

- **Batching:**
  - Decrease in batch waiting times, especially for express and cold orders.
  - Batch sizes stabilizing near designed targets (N_min) with fewer extreme waits.

- **Priority Handling:**
  - Express orders’ SLA adherence improves or remains high.
  - Standard orders’ waiting times do not deteriorate significantly; track if the gap between express and standard waiting is within designed bounds.

- **Hazardous Limits:**
  - Reduction in periods at limit=10 and in hazard-induced waiting times.
  - No regulatory breaches.
  - Better predictability of hazardous order lead times.

### 5.3 Continuous Improvement Loop

- Regularly export updated logs and rerun **conformance checking**:
  - Compare observed behavior against target policies (e.g., check if batches are closed according to new rules).
- Periodically re-fit service-time and arrival distributions:
  - If demand patterns change, adjust strategies (e.g., thresholds for batching, number of cold stations, hazard buffers).

---

In summary, the approach is:

1. Use detailed event-log analysis to **attribute waiting and delays to specific instance-spanning constraints**.
2. Study how constraints interact to create bottlenecks and variability.
3. Design **constraint-aware scheduling and batching rules** (plus small capacity/process changes) grounded in historical data.
4. Validate options in **simulation**, ensuring constraints are respected.
5. Deploy and monitor via focused dashboards, closing a continuous improvement loop.