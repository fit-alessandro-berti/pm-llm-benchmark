Below is a prompt you can give to another LLM that has access to this database. It is written so the model:

- Understands the schema and “normal” process
- Is explicitly asked to detect anomalies
- Is pushed to hypothesize root causes
- Is required to propose concrete SQL queries (using only the given tables)

You can paste this as-is (or adapt it) as the instruction for the target model.

---

## Prompt for the Target LLM

You are a data analyst with strong knowledge of SQL, process mining, and business-process diagnostics. You have read-only access to a PostgreSQL database with the following schema and meaning:

### Tables and Columns

**Table:** `order_event_log`  
Represents the event log of an order-handling process.  
Columns:
- `case_id` (INTEGER): Identifies a particular order (the “case”).
- `event_id` (INTEGER): Primary key for event records. Larger values do not necessarily imply a later timestamp across different cases, but within each case events are in temporal order.
- `activity` (VARCHAR): Name of the event/activity in the process.
- `timestamp` (TIMESTAMP): When the activity took place.
- `resource` (VARCHAR): The person/system performing the activity. Links to `resources.resource_id`.
- `additional_info` (VARCHAR): Semi-structured information like `channel=online`, `credit_score=810`, `shipment_scheduled=Y`, `amount=1250.00`, etc.

**Table:** `orders`  
Contains high-level information about orders.  
Columns:
- `case_id` (INTEGER): Matches `order_event_log.case_id`.
- `customer_id` (INTEGER): Identifies the customer.
- `order_type` (VARCHAR): E.g., `standard`, `priority`.
- `order_value` (DECIMAL): Monetary value of the order.

**Table:** `resources`  
Contains metadata about the resources performing activities.  
Columns:
- `resource_id` (VARCHAR): Matches `order_event_log.resource`.
- `role` (VARCHAR): Role of the resource (e.g., `SalesRep`, `CreditOfficer`, `WarehouseClerk`, etc.).
- `department` (VARCHAR): Department of the resource (e.g., `Sales`, `Finance`, `Logistics`).

### Assumed “Normal” Process Flow

The intended, ideal sequence of activities for an order is:

1. `Register Order` (Sales)
2. `Perform Credit Check` (Finance)
3. `Validate Stock` (Warehouse)
4. `Confirm Shipment` (Logistics)
5. `Ship Goods` (Logistics)
6. `Issue Invoice` (Finance)
7. `Receive Payment` (Finance)

In reality, the data may contain deviations from this ideal order, missing steps, extra steps, or strange resource assignments.

### Your Tasks

1. **Identify anomalies and undesirable behaviors** in the event log, based on:
   - Control-flow anomalies (e.g., activities out of sequence vs. the “normal” flow, missing steps, unexpected loops or skips).
   - Timing anomalies (e.g., unusually short or long times between certain activities, payment before invoice, shipment before credit check, etc.).
   - Resource/organizational anomalies (e.g., wrong department doing an activity, same person doing conflicting steps, segregation-of-duties violations).
   - Data-related anomalies (e.g., order_value vs. payment amount mismatches, suspicious `additional_info` patterns).

   You should:
   - Reference the **ideal process** above as your main frame of reference.
   - Think in terms of patterns across many cases, not just single examples.
   - Consider both local anomalies (within a single case) and global anomalies (activities or patterns that rarely happen compared to the norm).

2. **Hypothesize potential reasons for these anomalies**:
   - For each type/category of anomaly you detect or suspect, propose plausible root causes or explanations.
   - These can include, for example: system bugs, policy violations, training issues, workarounds, capacity constraints, exceptional orders (e.g., VIP, pre-paid, cash-on-delivery), data quality issues, integration failures, etc.
   - Make the hypotheses explicit and clearly linked to particular patterns you want to investigate.

3. **Propose concrete SQL queries** (in PostgreSQL dialect) that you would run to:
   - Detect and quantify the anomalies you described.
   - Explore your hypotheses and either support or challenge them.
   - Find which cases, resources, or order types are most affected.

   Requirements for the SQL:
   - Use only the tables: `order_event_log`, `orders`, and `resources`.
   - You may use common SQL features such as `JOIN`, `GROUP BY`, `HAVING`, window functions (`LAG`, `LEAD`, `ROW_NUMBER`, etc.), date/time functions, and string functions.
   - Write full, runnable SQL statements, not pseudocode.
   - Each query should be accompanied by a short explanation of:
     - What anomaly or hypothesis it is targeting.
     - What the expected output structure is (e.g., columns and meaning).
     - How you would interpret the results.

### Examples of the Types of Patterns You Might Consider

These are **examples only**. Do not restrict yourself to just these; think broadly.

- **Out-of-order activities**:
  - Cases where `Ship Goods` occurs before `Perform Credit Check`.
  - `Receive Payment` before `Issue Invoice`.
  - `Confirm Shipment` after `Ship Goods` instead of before.

- **Missing or skipped steps**:
  - Orders that never had `Perform Credit Check`.
  - Orders with shipment but no `Confirm Shipment`.
  - Orders that never reach `Receive Payment`.

- **Suspicious timing**:
  - Very short time from `Register Order` to `Ship Goods` (possibly bypassing checks).
  - Very long delays between `Issue Invoice` and `Receive Payment`.
  - Payment received before or immediately after registration (potential prepayment or data-entry anomalies).

- **Resource/role violations**:
  - Activities executed by resources whose `department` does not match the expected department for that activity (e.g., someone from `Sales` performing `Perform Credit Check` which should be `Finance`).
  - Same resource performing both credit check and payment receipt when policy should separate these duties.

- **Financial inconsistencies**:
  - Sum of `amount` in `Receive Payment` events vs. `order_value` in `orders`.
  - Multiple payments for the same order that exceed the order value.
  - Priority orders (`order_type = 'priority'`) that don’t follow faster or more controlled paths.

You are not limited to these examples; they are only to stimulate your thinking.

### Output Requirements

Produce your answer in the following structure:

1. **Anomaly Types and Descriptions**  
   - List and describe each anomaly / undesirable pattern you think is relevant to investigate, grouped by category (control-flow, timing, resource/organizational, data/financial).  
   - For each, describe what the anomaly looks like conceptually (e.g., “activity B occurs before activity A within the same case”).

2. **Hypotheses for Root Causes**  
   - For each anomaly type above, list one or more plausible hypotheses about what could be causing it.  
   - Where relevant, mention what kind of business or system behavior would be consistent with the anomaly.

3. **SQL Queries to Investigate**  
   - For each anomaly type, provide one or more SQL queries:
     - The full SQL.
     - A brief explanation of what it does, what output columns mean, and how to interpret them in light of the anomaly.
   - Where helpful, include queries that:
     - Count how many cases are affected.
     - List top N problematic cases/resources.
     - Compare distributions (e.g. time lags) between normal and anomalous cases.

Focus on being systematic: cover a range of anomaly types, link them clearly to hypotheses, and provide SQL that would allow an analyst to explore and validate those hypotheses in this specific schema.