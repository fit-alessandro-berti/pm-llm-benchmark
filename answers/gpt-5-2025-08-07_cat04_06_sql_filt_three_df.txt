-- Return all events except those from cases that contain the direct sequence
-- Approve Purchase Requisition -> Create Order -> Confirm Order
-- with Create->Confirm gap > 5 days

WITH ordered AS (
  SELECT
    case_id,
    activity,
    "timestamp",
    LEAD(activity, 1) OVER w AS next_activity,
    LEAD("timestamp", 1) OVER w AS next_ts,
    LEAD(activity, 2) OVER w AS next2_activity,
    LEAD("timestamp", 2) OVER w AS next2_ts
  FROM event_log
  WINDOW w AS (PARTITION BY case_id ORDER BY "timestamp", activity)
),
bad_cases AS (
  SELECT DISTINCT case_id
  FROM ordered
  WHERE activity = 'Approve Purchase Requisition'
    AND next_activity = 'Create Order'
    AND next2_activity = 'Confirm Order'
    AND (next2_ts - next_ts) > INTERVAL 5 DAY
)
SELECT e.*
FROM event_log e
WHERE e.case_id NOT IN (SELECT case_id FROM bad_cases)
ORDER BY e.case_id, e."timestamp", e.activity;