# DuckDB SQL Query for Process Mining Event Log Filtering

## Problem Analysis

The task requires:
1. **Detect a specific sequence**: Three activities in direct succession (no events in between)
2. **Apply timing condition**: Time between 'Create Order' and 'Confirm Order' > 5 days
3. **Exclude matching cases**: Return only events from cases that DON'T match both criteria

## Solution

```sql
WITH ordered_events AS (
    -- Step 1: Add LEAD columns to examine subsequent events in each case
    SELECT 
        case_id,
        activity,
        timestamp,
        LEAD(activity, 1) OVER (
            PARTITION BY case_id 
            ORDER BY timestamp
        ) AS next_activity,
        LEAD(activity, 2) OVER (
            PARTITION BY case_id 
            ORDER BY timestamp
        ) AS next_next_activity,
        LEAD(timestamp, 1) OVER (
            PARTITION BY case_id 
            ORDER BY timestamp
        ) AS next_timestamp,
        LEAD(timestamp, 2) OVER (
            PARTITION BY case_id 
            ORDER BY timestamp
        ) AS next_next_timestamp
    FROM event_log
),

cases_to_exclude AS (
    -- Step 2: Identify cases with the target sequence AND timing condition
    SELECT DISTINCT case_id
    FROM ordered_events
    WHERE 
        -- Check for direct succession of the three activities
        activity = 'Approve Purchase Requisition'
        AND next_activity = 'Create Order'
        AND next_next_activity = 'Confirm Order'
        -- Check timing condition: > 5 days between Create Order and Confirm Order
        AND (next_next_timestamp - next_timestamp) > INTERVAL '5 days'
)

-- Step 3: Return all events EXCEPT those from excluded cases
SELECT el.*
FROM event_log el
WHERE el.case_id NOT IN (
    SELECT case_id 
    FROM cases_to_exclude
)
ORDER BY el.case_id, el.timestamp;
```

## How It Works

```

                      ordered_events CTE                         

  Uses LEAD() window function to "look ahead" at the next       
  two activities and their timestamps for each event            
                                                                 
  Event N:     activity          timestamp                       
  Event N+1:   next_activity     next_timestamp                  
  Event N+2:   next_next_activity next_next_timestamp            

                              
                              

                    cases_to_exclude CTE                         

  Filters for:                                                   
   Direct sequence match (no gaps by design of LEAD)           
   Time between Create Order  Confirm Order > 5 days          

                              
                              

                       Final SELECT                              

  Returns all events from event_log WHERE case_id               
  is NOT in the exclusion list                                   

```

## Key Design Decisions

| Aspect | Approach | Rationale |
|--------|----------|-----------|
| **Sequence Detection** | `LEAD(activity, 1)` and `LEAD(activity, 2)` | Directly captures next two activities in order, ensuring no gaps |
| **Time Calculation** | `next_next_timestamp - next_timestamp` | Calculates interval between 2nd and 3rd activity of the sequence |
| **Time Comparison** | `> INTERVAL '5 days'` | DuckDB-native interval arithmetic for precise comparison |
| **Exclusion Method** | `NOT IN` subquery | Clean and readable; can be replaced with `NOT EXISTS` for large datasets |

## Alternative: Using NOT EXISTS (Better for NULL Handling)

```sql
-- Replace the final SELECT with:
SELECT el.*
FROM event_log el
WHERE NOT EXISTS (
    SELECT 1 
    FROM cases_to_exclude cte 
    WHERE cte.case_id = el.case_id
)
ORDER BY el.case_id, el.timestamp;
```