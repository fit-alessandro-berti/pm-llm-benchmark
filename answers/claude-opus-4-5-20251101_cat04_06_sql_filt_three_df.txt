# DuckDB SQL Query for Process Mining Event Log Filtering

## Problem Analysis

We need to:
1. Find cases with a **direct succession** of three specific activities
2. Filter those where the time between 'Create Order' and 'Confirm Order' exceeds 5 days
3. **Exclude** all events from those cases from our final result

## Solution

```sql
WITH ordered_events AS (
    -- Assign row numbers to establish event ordering within each case
    SELECT 
        case_id,
        activity,
        timestamp,
        ROW_NUMBER() OVER (PARTITION BY case_id ORDER BY timestamp) AS event_seq
    FROM event_log
),

sequences AS (
    -- Identify direct successions of the three target activities
    SELECT 
        e1.case_id,
        e1.activity AS activity_1,
        e2.activity AS activity_2,
        e3.activity AS activity_3,
        e1.timestamp AS ts_approve,
        e2.timestamp AS ts_create,
        e3.timestamp AS ts_confirm
    FROM ordered_events e1
    INNER JOIN ordered_events e2 
        ON e1.case_id = e2.case_id 
        AND e2.event_seq = e1.event_seq + 1  -- Direct succession (no gap)
    INNER JOIN ordered_events e3 
        ON e2.case_id = e3.case_id 
        AND e3.event_seq = e2.event_seq + 1  -- Direct succession (no gap)
    WHERE 
        e1.activity = 'Approve Purchase Requisition'
        AND e2.activity = 'Create Order'
        AND e3.activity = 'Confirm Order'
),

cases_to_exclude AS (
    -- Filter sequences where time between Create Order and Confirm Order > 5 days
    SELECT DISTINCT case_id
    FROM sequences
    WHERE ts_confirm - ts_create > INTERVAL '5 days'
)

-- Return all events EXCEPT those from excluded cases
SELECT el.*
FROM event_log el
WHERE el.case_id NOT IN (SELECT case_id FROM cases_to_exclude);
```

## Explanation

### Step 1: `ordered_events` CTE
- Assigns a sequential number (`event_seq`) to each event within a case
- Orders events by timestamp to establish the actual process flow

### Step 2: `sequences` CTE
- Uses **self-joins** to find consecutive events (using `event_seq + 1`)
- Ensures **direct succession** - no events can exist between the three activities
- Filters for the exact activity pattern required

### Step 3: `cases_to_exclude` CTE
- Applies the **timing condition**: time between 'Create Order' and 'Confirm Order' > 5 days
- Uses `DISTINCT` since a case might have multiple matching sequences

### Step 4: Final SELECT
- Returns all events from `event_log` where the `case_id` is **NOT** in the exclusion list

## Visual Representation

```

                        event_log                                

  case_id    activity                        timestamp         

  CASE_A     Approve Purchase Requisition    2024-01-01        
  CASE_A     Create Order                    2024-01-02         
  CASE_A     Confirm Order                   2024-01-10          > 5 days  EXCLUDE

  CASE_B     Approve Purchase Requisition    2024-01-01        
  CASE_B     Create Order                    2024-01-02         
  CASE_B     Confirm Order                   2024-01-04           5 days  KEEP

  CASE_C     Approve Purchase Requisition    2024-01-01        
  CASE_C     Review                          2024-01-02          Breaks sequence
  CASE_C     Create Order                    2024-01-03        
  CASE_C     Confirm Order                   2024-01-15            KEEP (not direct)

```