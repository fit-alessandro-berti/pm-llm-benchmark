# Process Tree Construction for Hospital Patient Management

## Analysis

Let me break down the process into its structural components:

| Step | Structure | Description |
|------|-----------|-------------|
| 1 | Sequence | A  RG  IA |
| 2 | Sequence | TI  TC |
| 3 | XOR | CE or FBP |
| 4 | Loop | *( , (SC, X(TM,SPT), X(FCE,FBA)) ) — zero or more treatment cycles |
| 5 | Parallel | AI  NC |
| 6 | Sequence | FAS  DDI |
| 7 | Parallel | BL  ICP  MRF |

All of steps 1–7 are executed in one **top-level sequence**, which can be flattened.

### Key Modeling Decision — The Loop

The loop uses `*(tau, body)`:
- **Do-part = `tau`** (silent): represents the evaluation/decision checkpoint.
- **Redo-part = `(SC, X(TM,SPT), X(FCE,FBA))`**: the treatment cycle.
- On the first pass, `tau` executes (silently). If results are **normal**, the loop exits immediately (zero iterations of the body). If **abnormal**, the redo-part fires, then `tau` again, and so on — allowing **zero or more** treatment cycles, exactly as described.

## Process Tree (Formal Notation)

```
->( 'A', 'RG', 'IA', 'TI', 'TC',
    X( 'CE', 'FBP' ),
    *( tau, ->( 'SC', X( 'TM', 'SPT' ), X( 'FCE', 'FBA' ) ) ),
    +( 'AI', 'NC' ),
    'FAS', 'DDI',
    +( 'BL', 'ICP', 'MRF' )
)
```

## Python Code

```python
from pm4py.objects.process_tree.obj import ProcessTree, Operator

#  Root: top-level sequence encompassing the entire patient journey 
root = ProcessTree(operator=Operator.SEQUENCE)

#  Step 1: Arrival  Registration  Intake Assessment 
A   = ProcessTree(label="A",  parent=root)
RG  = ProcessTree(label="RG", parent=root)
IA  = ProcessTree(label="IA", parent=root)

#  Step 2: Triage Interview  Triage Classification (flattened) 
TI  = ProcessTree(label="TI", parent=root)
TC  = ProcessTree(label="TC", parent=root)

#  Step 3: Exclusive initial diagnostic choice 
xor_initial_diag = ProcessTree(operator=Operator.XOR, parent=root)
CE  = ProcessTree(label="CE",  parent=xor_initial_diag)
FBP = ProcessTree(label="FBP", parent=xor_initial_diag)
xor_initial_diag.children = [CE, FBP]

#  Step 4: Loop — *( tau, (SC, X(TM,SPT), X(FCE,FBA)) ) 
loop = ProcessTree(operator=Operator.LOOP, parent=root)

#   Do-part: silent step (evaluation checkpoint)
tau_node = ProcessTree(label=None, parent=loop)          # tau

#   Redo-part: sequence of consultation  treatment  re-diagnostic
redo_seq = ProcessTree(operator=Operator.SEQUENCE, parent=loop)

SC = ProcessTree(label="SC", parent=redo_seq)

xor_treatment = ProcessTree(operator=Operator.XOR, parent=redo_seq)
TM  = ProcessTree(label="TM",  parent=xor_treatment)
SPT = ProcessTree(label="SPT", parent=xor_treatment)
xor_treatment.children = [TM, SPT]

xor_rdt = ProcessTree(operator=Operator.XOR, parent=redo_seq)
FCE = ProcessTree(label="FCE", parent=xor_rdt)
FBA = ProcessTree(label="FBA", parent=xor_rdt)
xor_rdt.children = [FCE, FBA]

redo_seq.children = [SC, xor_treatment, xor_rdt]
loop.children = [tau_node, redo_seq]

#  Step 5: Advanced Imaging  Nutritional Counseling 
par_advanced = ProcessTree(operator=Operator.PARALLEL, parent=root)
AI = ProcessTree(label="AI", parent=par_advanced)
NC = ProcessTree(label="NC", parent=par_advanced)
par_advanced.children = [AI, NC]

#  Step 6: Follow-up Scheduling  Discharge Instructions (flattened) 
FAS = ProcessTree(label="FAS", parent=root)
DDI = ProcessTree(label="DDI", parent=root)

#  Step 7: Billing  Insurance Claims  Medical Records Finalization 
par_admin = ProcessTree(operator=Operator.PARALLEL, parent=root)
BL  = ProcessTree(label="BL",  parent=par_admin)
ICP = ProcessTree(label="ICP", parent=par_admin)
MRF = ProcessTree(label="MRF", parent=par_admin)
par_admin.children = [BL, ICP, MRF]

#  Assemble root children in process order 
root.children = [
    A, RG, IA,              # Step 1
    TI, TC,                  # Step 2
    xor_initial_diag,        # Step 3
    loop,                    # Step 4
    par_advanced,            # Step 5
    FAS, DDI,                # Step 6
    par_admin                # Step 7
]
```

## Structural Verification

```
SEQUENCE (root)
 'A'
 'RG'
 'IA'
 'TI'
 'TC'
 XOR
    'CE'
    'FBP'
 LOOP
    tau                           do-part (silent evaluation)
    SEQUENCE                      redo-part
        'SC'
        XOR
           'TM'
           'SPT'
        XOR
            'FCE'
            'FBA'
 PARALLEL
    'AI'
    'NC'
 'FAS'
 'DDI'
 PARALLEL
     'BL'
     'ICP'
     'MRF'
```

**Example trace (one possible execution):**
`A  RG  IA  TI  TC  CE  SC  TM  FCE  SC  SPT  FBA  NC  AI  FAS  DDI  ICP  BL  MRF`

This trace shows: cardiac path chosen, two loop iterations (first TM+FCE, then SPT+FBA), parallel activities interleaved, then final admin steps in arbitrary order.