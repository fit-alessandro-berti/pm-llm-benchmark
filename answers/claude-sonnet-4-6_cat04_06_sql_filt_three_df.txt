# DuckDB SQL Query: Filtering Cases by Activity Sequence and Timing

## Approach

I'll use window functions to detect direct succession (no events in between) and then filter based on the timing condition.

```sql
WITH 
-- Step 1: Assign row numbers to establish event order within each case
ordered_events AS (
    SELECT
        case_id,
        activity,
        timestamp,
        ROW_NUMBER() OVER (
            PARTITION BY case_id 
            ORDER BY timestamp
        ) AS rn
    FROM event_log
),

-- Step 2: Self-join to find consecutive triplets of activities
-- We need exact consecutive positions (rn, rn+1, rn+2)
sequence_candidates AS (
    SELECT
        e1.case_id,
        e1.activity  AS act1,
        e2.activity  AS act2,
        e3.activity  AS act3,
        e1.timestamp AS ts1,
        e2.timestamp AS ts2,
        e3.timestamp AS ts3
    FROM ordered_events e1
    -- e2 must be immediately after e1 (no gaps)
    INNER JOIN ordered_events e2
        ON  e1.case_id = e2.case_id
        AND e2.rn = e1.rn + 1
    -- e3 must be immediately after e2 (no gaps)
    INNER JOIN ordered_events e3
        ON  e2.case_id = e3.case_id
        AND e3.rn = e2.rn + 1
    WHERE
        e1.activity = 'Approve Purchase Requisition'
        AND e2.activity = 'Create Order'
        AND e3.activity = 'Confirm Order'
),

-- Step 3: Identify cases where the sequence exists AND
-- the time between 'Create Order' and 'Confirm Order' exceeds 5 days
cases_to_exclude AS (
    SELECT DISTINCT case_id
    FROM sequence_candidates
    WHERE
        -- Time between Create Order (ts2) and Confirm Order (ts3) > 5 days
        (ts3 - ts2) > INTERVAL '5' DAY
)

-- Step 4: Return all events EXCEPT those belonging to excluded cases
SELECT
    el.*
FROM event_log el
WHERE
    el.case_id NOT IN (SELECT case_id FROM cases_to_exclude)
ORDER BY
    el.case_id,
    el.timestamp;
```

## Step-by-Step Explanation

| Step | CTE Name | Purpose |
|------|----------|---------|
| 1 | `ordered_events` | Assigns sequential row numbers per case ordered by timestamp |
| 2 | `sequence_candidates` | Finds triplets where the three activities occur in **direct succession** (consecutive `rn` values) |
| 3 | `cases_to_exclude` | Filters triplets where `Confirm Order` comes **more than 5 days** after `Create Order` |
| 4 | Final `SELECT` | Returns all events **excluding** those from identified cases |

## Key Design Decisions

- **Direct succession** is enforced by requiring `e2.rn = e1.rn + 1` and `e3.rn = e2.rn + 1`, ensuring no intermediate events exist between the three activities.
- **Interval comparison** uses DuckDB's native `INTERVAL '5' DAY` syntax for readable date arithmetic.
- **`DISTINCT`** in `cases_to_exclude` prevents duplicate case IDs if the sequence appears multiple times in a case.
- **`NOT IN`** cleanly excludes all events from flagged cases, preserving the complete event history for all other cases.