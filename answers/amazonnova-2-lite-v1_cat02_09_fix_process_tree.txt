### **Analysis and Solution: Fixing the Underfitting Process Tree Model for Procure-to-Pay**

---

## **1. Identifying Issues in the Current Model**

The **current process tree model** suffers from **underfitting** due to the **use of a parallel (AND) block** for the core activities after requisition approval. This allows **unwanted behavior**, such as:

- **Paying the invoice before receiving goods or the invoice.**
- **Matching the invoice to the PO before the goods are received.**
- **Creating the purchase order after the invoice is received.**
- **Performing activities in any arbitrary order**, which **violates domain logic**.

### **Domain-Appropriate Order of Events**

The correct sequence of events in a **Procure-to-Pay (P2P)** process should be strictly sequential, with **no parallelism** among the core activities:

1. **Create Purchase Requisition**
2. **Approve Purchase Requisition**
3. **Create Purchase Order**
4. **Receive Goods**
5. **Receive Invoice**
6. **Match Invoice to PO**
7. **Pay Invoice**
8. **Close Case**

Some of these steps **must happen in strict order**:
- You **cannot** create a purchase order before approving the requisition.
- You **cannot** receive goods before the purchase order is created.
- You **cannot** match the invoice before receiving the goods.
- You **cannot** pay the invoice before matching it to the PO.
- You **cannot** close the case before payment is made.

---

## **2. Corrected Process Tree Model**

We will **replace the parallel block** with a **strict SEQUENCE**, preserving all the same activities but enforcing the correct order.

Here is the **corrected model** in Python pseudocode using `pm4py`:

```python
from pm4py.objects.process_tree.obj import Operator, ProcessTree

# Define activities
create_req = ProcessTree(label="Create_Purchase_Requisition")
approve_req = ProcessTree(label="Approve_Purchase_Requisition")
create_po = ProcessTree(label="Create_Purchase_Order")
receive_goods = ProcessTree(label="Receive_Goods")
receive_invoice = ProcessTree(label="Receive_Invoice")
match_invoice = ProcessTree(label="Match_Invoice_to_PO")
pay_invoice = ProcessTree(label="Pay_Invoice")
close_case = ProcessTree(label="Close_Case")

# Define the corrected sequence of activities
core_sequence = ProcessTree(operator=Operator.SEQUENCE, children=[
    create_po,
    receive_goods,
    receive_invoice,
    match_invoice,
    pay_invoice
])

# Root of the process tree: strict sequence from start to finish
root = ProcessTree(operator=Operator.SEQUENCE, children=[
    create_req,
    approve_req,
    core_sequence,
    close_case
])
```

---

## **3. Explanation: How the Updated Model Enforces Correct Behavior**

###  **Enforced Correct Sequence**

The updated model **flattens the entire process into a single sequence**, ensuring that:

- `"Create Purchase Order"` **must** occur **after** `"Approve Purchase Requisition"` and **before** `"Receive Goods"`.
- `"Receive Goods"` **must** happen **before** `"Receive Invoice"`.
- `"Match Invoice to PO"` **must** occur **after** `"Receive Invoice"` and **before** `"Pay Invoice"`.
- `"Pay Invoice"` **must** occur **before** `"Close Case"`.

###  **Prevents Unwanted Behavior**

With the **parallel block removed**, the following **illegal sequences are now blocked**:

| Illegal Sequence | Why It’s Blocked |
|------------------|------------------|
| Pay Invoice  Receive Goods | Payment cannot occur before goods are received. |
| Match Invoice  Receive Goods | Invoice matching requires goods to be received first. |
| Receive Invoice  Create PO | You must have a PO before receiving an invoice. |
| Close Case  Pay Invoice | Case cannot close before payment is made. |

###  **Why This Model Is Correct**

- **No parallelism** where it shouldn't exist: Activities that are logically dependent are **forced into a sequence**.
- **No choices or loops** are introduced, preserving the **linear, deterministic flow** of a standard P2P process.
- **All original activities are retained**, ensuring **model fidelity** while **eliminating ambiguity**.

---

##  **Summary**

| Aspect | Before | After |
|-------|--------|-------|
| **Order Enforcement** | Weak (parallel block allows arbitrary order) | Strong (strict sequence) |
| **Unwanted Behavior** | Allowed (e.g., pay before goods) | Prevented |
| **Domain Compliance** | Low | High |
| **Model Complexity** | High (unnecessary parallelism) | Low (clean sequence) |

### **Conclusion**

The corrected process tree **strictly enforces** the domain-specific sequence of events in a **Procure-to-Pay** process. It removes the **parallel block**, which was the source of underfitting, and replaces it with a **linear sequence**, ensuring **only valid paths** are possible. This leads to a **more accurate, interpretable, and domain-compliant process model**.