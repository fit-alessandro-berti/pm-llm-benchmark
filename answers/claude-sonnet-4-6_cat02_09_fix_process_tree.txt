# Analysis and Fix of the Procure-to-Pay Process Tree

## 1. Identifying the Issues

The current model places five critical activities inside a **PARALLEL (AND) block**, meaning they can execute in **any order simultaneously**:

| Unwanted Behavior Allowed | Why It's Wrong |
|---|---|
| Pay Invoice before Receive Goods | You can't pay for goods not yet received |
| Match Invoice before Receive Invoice | Can't match an invoice that doesn't exist yet |
| Pay Invoice before Match Invoice | Payment should only occur after 3-way match |
| Create PO after Receive Goods | Goods shouldn't arrive before a PO exists |
| Receive Invoice before Create PO | Invoice references a PO that doesn't exist |

The **entire process is strictly sequential** — each step has a hard dependency on the previous one completing first. There is no legitimate parallelism or choice in the standard Procure-to-Pay flow.

---

## 2. The Corrected Process Tree

```python
from pm4py.objects.process_tree.obj import Operator, ProcessTree

#  Define leaf activities 
create_req    = ProcessTree(label="Create_Purchase_Requisition")
approve_req   = ProcessTree(label="Approve_Purchase_Requisition")
create_po     = ProcessTree(label="Create_Purchase_Order")
receive_goods = ProcessTree(label="Receive_Goods")
receive_invoice = ProcessTree(label="Receive_Invoice")
match_invoice = ProcessTree(label="Match_Invoice_to_PO")
pay_invoice   = ProcessTree(label="Pay_Invoice")
close_case    = ProcessTree(label="Close_Case")

#  Corrected structure: one strict top-level SEQUENCE 
#
#  SEQUENCE
#   Create_Purchase_Requisition
#   Approve_Purchase_Requisition
#   Create_Purchase_Order
#   Receive_Goods
#   Receive_Invoice
#   Match_Invoice_to_PO
#   Pay_Invoice
#   Close_Case
#
root = ProcessTree(
    operator=Operator.SEQUENCE,
    children=[
        create_req,       # Step 1 – must come first
        approve_req,      # Step 2 – requisition must exist before approval
        create_po,        # Step 3 – approval required before issuing PO
        receive_goods,    # Step 4 – PO must exist before goods can be received
        receive_invoice,  # Step 5 – goods receipt triggers/accompanies invoice
        match_invoice,    # Step 6 – both goods receipt AND invoice must exist
        pay_invoice,      # Step 7 – only pay after successful 3-way match
        close_case        # Step 8 – administrative closure, always last
    ]
)
```

### Visual Representation

```
SEQUENCE

 Create_Purchase_Requisition

 Approve_Purchase_Requisition

 Create_Purchase_Order

 Receive_Goods

 Receive_Invoice

 Match_Invoice_to_PO

 Pay_Invoice

 Close_Case
```

---

## 3. How the Fixed Model Enforces Correct Behavior

### Enforcement Through Sequential Ordering

The single flat `SEQUENCE` operator enforces that **every activity must complete before the next one can start**. This directly mirrors the causal dependencies in Procure-to-Pay:

```
Create Req  Approve Req  Create PO  Receive Goods
                                                    
                                             Receive Invoice
                                                    
                                           Match Invoice to PO
                                                    
                                              Pay Invoice
                                                    
                                              Close Case
```

### Specific Violations Now Prevented

| Previously Allowed (Bad) | Now Prevented Because |
|---|---|
| `Pay_Invoice`  `Receive_Goods` | Pay comes **after** Receive_Goods in sequence |
| `Match_Invoice`  `Receive_Invoice` | Match comes **after** Receive_Invoice in sequence |
| `Receive_Invoice`  `Create_PO` | Receive_Invoice comes **after** Create_PO in sequence |
| `Receive_Goods`  `Create_PO` | Receive_Goods comes **after** Create_PO in sequence |
| All steps running concurrently | `PARALLEL` block has been **removed entirely** |

### Why No Parallelism or Choice Is Needed Here

- **No XOR (choice):** In the *happy path* standard model, every step is mandatory — there are no optional branches or alternative paths.
- **No PARALLEL:** While in real life goods receipt and invoice receipt can overlap slightly, the **3-way match** (PO + Goods Receipt + Invoice) means both must be complete before matching proceeds. Modeling them strictly in sequence is the **safest and most conformant** representation for a controlled process.
- **Result:** The language of this process tree is exactly **one trace** — the single intended sequence — making it **impossible** for any out-of-order execution to be replayed against or generated from this model.