# DuckDB SQL Query for Process Variant Analysis

Here's a comprehensive solution that addresses all your requirements:

```sql
WITH
-- Step 1: Get ordered activity sequences for each case
ordered_sequences AS (
    SELECT
        case_id,
        LISTAGG(activity, '  ') WITHIN GROUP (ORDER BY timestamp) AS activity_sequence
    FROM event_log
    GROUP BY case_id
),

-- Step 2: Count cases per variant and identify top K variants
variant_counts AS (
    SELECT
        activity_sequence,
        COUNT(DISTINCT case_id) AS case_count
    FROM ordered_sequences
    GROUP BY activity_sequence
    ORDER BY case_count DESC
    LIMIT K  -- Replace K with your desired number of top variants
),

-- Step 3: Get case_ids that belong to top K variants
top_variant_cases AS (
    SELECT
        os.case_id
    FROM ordered_sequences os
    JOIN variant_counts vc ON os.activity_sequence = vc.activity_sequence
)

-- Step 4: Return all events from cases in top K variants
SELECT
    el.*
FROM event_log el
JOIN top_variant_cases tvc ON el.case_id = tvc.case_id
ORDER BY el.case_id, el.timestamp;
```

## Explanation:

1. **Ordered Sequences Extraction**:
   - The first CTE (`ordered_sequences`) groups events by `case_id` and creates a string representation of the activity sequence using `LISTAGG` with `ORDER BY timestamp` to maintain chronological order.

2. **Variant Counting and Top K Selection**:
   - The second CTE (`variant_counts`) counts how many cases share each unique activity sequence and orders them by frequency in descending order.
   - The `LIMIT K` clause selects only the top K most frequent variants.

3. **Case Filtering**:
   - The third CTE (`top_variant_cases`) identifies all case_ids that belong to these top K variants.

4. **Final Event Selection**:
   - The main query joins the original event log with the filtered case_ids to return only events from cases that belong to the top K variants.

## Notes:

- Replace `K` with your desired number of top variants (e.g., `5` for top 5 variants).
- The query preserves all original event columns in the final output.
- If you need to handle NULL values in the activity sequence, you might want to add `NULLS LAST` to the `ORDER BY` clause in the `LISTAGG` function.
- For very large datasets, you might want to add appropriate indexes on `case_id` and `timestamp` columns.