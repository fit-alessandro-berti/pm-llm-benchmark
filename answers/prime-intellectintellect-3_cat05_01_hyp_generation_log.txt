<think>
We are given three tables: order_event_log, orders, and resources.
 The normal process flow is:
  1. Register Order (Sales)
  2. Perform Credit Check (Finance)
  3. Validate Stock (Warehouse)
  4. Confirm Shipment (Logistics)
  5. Ship Goods (Logistics)
  6. Issue Invoice (Finance)
  7. Receive Payment (Finance)

 We have four example orders (case_id: 1001, 1002, 1003, 1004) with their event logs.

 Steps:
 1. Identify anomalies and undesirable behaviors by comparing the actual event sequences with the normal flow.
 2. Hypothesize why these anomalies might occur.
 3. Propose SQL queries to investigate the anomalies.

 Let's analyze each order:

 Order 1001:
   Events: 
     1. Register Order
     2. Perform Credit Check
     3. Validate Stock
     4. Confirm Shipment
     5. Ship Goods
     6. Issue Invoice
     7. Receive Payment
   This follows the normal flow.

 Order 1002:
   Events:
     1. Register Order
     2. Confirm Shipment (Logistics) -> This is step 4, but we haven't done step 2 (Perform Credit Check) or step 3 (Validate Stock)
     3. Ship Goods (Logistics) -> step 5, but again missing credit check and stock validation.
     4. Perform Credit Check (Finance) -> step 2, but after shipment?
     5. Validate Stock (Warehouse) -> step 3, after shipment?
     6. Issue Invoice
     7. Receive Payment

   Anomalies:
     - Confirm Shipment and Ship Goods occurred before Perform Credit Check and Validate Stock.
     - This is a deviation from the normal process. It might be that the order was rushed (since it's a priority order) and the credit check and stock validation were done after shipment? But that is risky.

 Order 1003:
   Events:
     1. Register Order
     2. Perform Credit Check
     3. Ship Goods -> step 5, but missing step 3 (Validate Stock) and step 4 (Confirm Shipment) at this point?
     4. Issue Invoice
     5. Confirm Shipment -> step 4, but after shipping? (late confirmation)
     6. Receive Payment

   Anomalies:
     - Ship Goods (event 3) occurs before Confirm Shipment (event 5). Normally, Confirm Shipment should come before Ship Goods.
     - Validate Stock is missing entirely? But note: the normal flow has Validate Stock (step 3) before Confirm Shipment (step 4). In this order, we don't see Validate Stock at all.

   However, looking at the event log, we see:
        event_id: 17 -> activity: Ship Goods
        event_id: 19 -> activity: Confirm Shipment

   So the shipment was confirmed after the goods were shipped? That is late and might indicate a system error or manual override.

   Also, missing Validate Stock? But note: the event log does not have a "Validate Stock" event for case_id=1003. So that activity was skipped.

 Order 1004:
   Events:
     1. Register Order
     2. Receive Payment -> step 7, but very early? Before any other steps?
     3. Issue Invoice -> step 6, but after payment? Normally, invoice is issued before payment is received? But sometimes payment can be in advance.
     4. Confirm Shipment -> step 4, but note: the additional_info says shipment_scheduled=N -> meaning shipment not scheduled? But then...
     5. Ship Goods -> step 5, but without confirming shipment? And the shipment was not scheduled? This is odd.

   Anomalies:
     - Payment received immediately after order registration? This might be an online payment? But then the process should be:
          Register Order -> Issue Invoice -> Receive Payment -> ... 
        However, we don't see the credit check, stock validation, or shipment confirmation until after payment? But note: the payment is received at 09:05, then at 09:20 the invoice is issued? That is reversed: normally, invoice is issued and then payment is made.

     - The shipment was confirmed but marked as not scheduled? And then goods were shipped? That doesn't make sense.

     - Also, missing: Perform Credit Check and Validate Stock? The event log for 1004 does not have these events.

 Summary of anomalies:

  A. Order 1002: 
      - Shipment confirmed and goods shipped before credit check and stock validation.

  B. Order 1003:
      - Goods shipped before shipment confirmation (late confirmation).
      - Validate Stock activity missing.

  C. Order 1004:
      - Payment received before invoice is issued? (But note: the events are: Register Order, then Receive Payment, then Issue Invoice -> so payment before invoice)
      - Missing credit check and stock validation?
      - Shipment confirmed as not scheduled (shipment_scheduled=N) but then goods were shipped? That is contradictory.

 Hypotheses:

  For Order 1002:
    - The order was marked as priority and the team tried to expedite by skipping some steps? But then they realized they need to do the credit check and stock validation, so they did it after shipment? This could be a policy violation.

  For Order 1003:
    - The warehouse shipped the goods without having a formal confirmation? Or the system allowed shipping without confirmation? Then the logistics manager confirmed the shipment later? This might be due to a system error or manual intervention.
    - The stock validation step was skipped? Maybe because the system assumed stock was available? Or an error in the process.

  For Order 1004:
    - The customer paid immediately (maybe by credit card) so the payment was recorded first? But then the invoice was generated later? This might be due to an asynchronous process? Or a system design flaw? 
    - The credit check and stock validation were skipped? Maybe because the payment was received in advance? But that doesn't eliminate the need for credit check? Unless the payment is considered as a guarantee? 
    - The shipment was confirmed as not scheduled? But then shipped? This is very odd. It might be a data entry error? Or the system allowed shipping without scheduling? 

 Proposed SQL queries to investigate:

  We want to check for deviations from the normal process.

  Let's define the normal process steps in order (by activity name):

    1. 'Register Order'
    2. 'Perform Credit Check'
    3. 'Validate Stock'
    4. 'Confirm Shipment'
    5. 'Ship Goods'
    6. 'Issue Invoice'
    7. 'Receive Payment'

  However, note that in the example of 1004, we have payment before invoice? That is a deviation.

  We can write a query to get the sequence of events per case, ordered by timestamp.

  But we are also interested in the actual order of activities.

  Approach:

  1. For each case, we can get the activities in the order they occurred (by timestamp) and then compare with the expected sequence.

  However, the normal sequence might not be strictly followed in reality? But we are looking for anomalies.

  Alternatively, we can check for:

    a. Missing activities in the process? (e.g., Validate Stock missing in 1003 and 1004? and also in 1002? Actually, 1002 has Validate Stock but after shipment)

    b. Activities out of order? (e.g., shipment before confirmation, payment before invoice, etc.)

  Let's break down:

  Anomaly 1: Missing activities.

    We can list all activities that are expected in the normal flow and check if they are present per case.

    Expected activities: 
        'Register Order', 
        'Perform Credit Check', 
        'Validate Stock', 
        'Confirm Shipment', 
        'Ship Goods', 
        'Issue Invoice', 
        'Receive Payment'

    But note: in the example, order 1004 does not have 'Perform Credit Check' and 'Validate Stock'. Similarly, order 1003 does not have 'Validate Stock'.

    Query to find cases missing any of the activities (except maybe we can allow some to be missing? but the normal flow has them all?):

        SELECT 
            oel.case_id,
            oel.activity AS missing_activity
        FROM 
            (SELECT DISTINCT case_id, activity 
             FROM order_event_log
             WHERE activity IN ('Perform Credit Check', 'Validate Stock')
            ) AS expected_activities
        RIGHT JOIN 
            (SELECT case_id, activity 
             FROM order_event_log
            ) AS all_activities
        ON expected_activities.case_id = all_activities.case_id 
            AND expected_activities.activity = all_activities.activity
        WHERE expected_activities.case_id IS NULL;

    But note: we are only checking for two activities? We can extend to all expected activities.

    Alternatively, we can check per case which expected activities are missing:

        WITH expected_activities AS (
            SELECT 
                case_id,
                activity
            FROM 
                (VALUES 
                    ('Register Order'),
                    ('Perform Credit Check'),
                    ('Validate Stock'),
                    ('Confirm Shipment'),
                    ('Ship Goods'),
                    ('Issue Invoice'),
                    ('Receive Payment')
                ) AS expected(activity)
            CROSS JOIN 
                (SELECT DISTINCT case_id FROM order_event_log) AS cases
        )
        SELECT 
            expected.case_id,
            expected.activity AS missing_activity
        FROM expected_activities expected
        LEFT JOIN order_event_log oel 
            ON expected.case_id = oel.case_id 
            AND expected.activity = oel.activity
        WHERE oel.case_id IS NULL;

    This will list every case and every expected activity that is missing.

  Anomaly 2: Activities out of order.

    We can assign an expected order to each activity and then compare the actual order (by timestamp) to the expected order.

    Expected order mapping:

        activity                 | expected_order
        -------------------------|---------------
        Register Order           | 1
        Perform Credit Check     | 2
        Validate Stock           | 3
        Confirm Shipment         | 4
        Ship Goods               | 5
        Issue Invoice            | 6
        Receive Payment          | 7

    But note: in reality, the process might have some parallelism? However, in the normal flow, we assume sequential.

    We can:

        Step 1: For each case, get the events with their actual order (by timestamp) and the expected order.

        Step 2: Then check if the actual order of the activities (by the expected_order) is increasing? But note: multiple events can have the same timestamp? Then we rely on event_id? But the event_id is arbitrary.

        Alternatively, we can assign a rank per case by timestamp and then compare the rank of each activity with the expected order.

        However, we are more interested in specific deviations:

          - Shipment before confirmation: 
                activity 'Ship Goods' occurs before 'Confirm Shipment'

          - Payment before invoice: 
                activity 'Receive Payment' occurs before 'Issue Invoice'

          - Credit check after shipment: 
                activity 'Perform Credit Check' occurs after 'Ship Goods'

          - Stock validation after shipment: 
                activity 'Validate Stock' occurs after 'Ship Goods'

        We can write a query for each of these.

    Example: Find cases where 'Ship Goods' occurs before 'Confirm Shipment'

        SELECT 
            o1.case_id
        FROM 
            order_event_log o1
        JOIN 
            order_event_log o2 ON o1.case_id = o2.case_id
        WHERE 
            o1.activity = 'Ship Goods'
            AND o2.activity = 'Confirm Shipment'
            AND o1.timestamp < o2.timestamp;

    Similarly, for payment before invoice:

        SELECT 
            o1.case_id
        FROM 
            order_event_log o1
        JOIN 
            order_event_log o2 ON o1.case_id = o2.case_id
        WHERE 
            o1.activity = 'Receive Payment'
            AND o2.activity = 'Issue Invoice'
            AND o1.timestamp < o2.timestamp;

    For credit check after shipment:

        SELECT 
            o1.case_id
        FROM 
            order_event_log o1
        JOIN 
            order_event_log o2 ON o1.case_id = o2.case_id
        WHERE 
            o1.activity = 'Perform Credit Check'
            AND o2.activity = 'Ship Goods'
            AND o1.timestamp > o2.timestamp;

    For stock validation after shipment:

        SELECT 
            o1.case_id
        FROM 
            order_event_log o1
        JOIN 
            order_event_log o2 ON o1.case_id = o2.case_id
        WHERE 
            o1.activity = 'Validate Stock'
            AND o2.activity = 'Ship Goods'
            AND o1.timestamp > o2.timestamp;

  Anomaly 3: For order 1004, we have 'Confirm Shipment' with additional_info 'shipment_scheduled=N'. We want to check if there are other cases with similar situation? And what happened after?

        SELECT 
            case_id,
            resource,
            additional_info
        FROM order_event_log
        WHERE activity = 'Confirm Shipment'
            AND additional_info LIKE '%shipment_scheduled=N%';

    Then we can check if after such confirmation, the goods were shipped? 

        SELECT 
            o1.case_id
        FROM 
            order_event_log o1
        JOIN 
            order_event_log o2 ON o1.case_id = o2.case_id
        WHERE 
            o1.activity = 'Confirm Shipment'
            AND o1.additional_info LIKE '%shipment_scheduled=N%'
            AND o2.activity = 'Ship Goods'
            AND o2.timestamp > o1.timestamp;

  Anomaly 4: Missing activities per order type? 

    We have order_type in the orders table. We might want to see if priority orders (like 1002) are more prone to skipping steps? 

    We can join the orders table to see the order_type for the cases that have missing activities or out-of-order events.

  Additional investigation:

    We might also want to check the roles and departments to see if the right resource is performing the activity? 

    For example, in the normal flow:

        Register Order -> Sales
        Perform Credit Check -> Finance
        Validate Stock -> Logistics (Warehouse)
        Confirm Shipment -> Logistics
        Ship Goods -> Logistics
        Issue Invoice -> Finance
        Receive Payment -> Finance

    We can check if the resource's role and department match the expected.

    We have the resources table.

    Expected mapping:

        activity                 | expected_role        | expected_department
        -------------------------|----------------------|---------------------
        Register Order           | Sales Executive      | Sales
        Perform Credit Check     | Credit Analyst       | Finance
        Validate Stock           | Warehouse Staff      | Logistics
        Confirm Shipment         | Logistics Manager    | Logistics
        Ship Goods               | Warehouse Staff      | Logistics
        Issue Invoice            | Accountant, Billing Officer, Cashier? -> but we have multiple roles in Finance. We can group by department? 
        Receive Payment          | Cashier, Accountant, Billing Officer? 

    Actually, the roles for Finance are: Accountant, Cashier, Billing Officer. So we can check if the resource's role is in a set and department is Finance.

    We can write a query to flag activities performed by the wrong department or role.

        WITH expected AS (
            SELECT 
                activity,
                'Sales' AS expected_department,
                'Sales Executive' AS expected_role
            FROM (VALUES ('Register Order')) AS t(activity)
            UNION ALL
            SELECT 'Perform Credit Check', 'Finance', 'Credit Analyst'
            UNION ALL
            SELECT 'Validate Stock', 'Logistics', 'Warehouse Staff'
            UNION ALL
            SELECT 'Confirm Shipment', 'Logistics', 'Logistics Manager'
            UNION ALL
            SELECT 'Ship Goods', 'Logistics', 'Warehouse Staff'
            UNION ALL
            SELECT 'Issue Invoice', 'Finance', NULL   -- because multiple roles are possible in Finance
            UNION ALL
            SELECT 'Receive Payment', 'Finance', NULL
        )
        SELECT 
            oel.case_id,
            oel.activity,
            oel.resource,
            r.department AS actual_department,
            r.role AS actual_role,
            expected.expected_department,
            expected.expected_role
        FROM order_event_log oel
        JOIN resources r ON oel.resource = r.resource_id
        JOIN expected ON oel.activity = expected.activity
        WHERE 
            (expected.expected_department IS NOT NULL AND r.department <> expected.expected_department)
            OR 
            (expected.expected_role IS NOT NULL AND r.role <> expected.expected_role);

    But note: for Finance activities, we don't have a specific role? So we might only check the department? 

        We can adjust: if expected_role is NULL, then we only check department? 

        Alternatively, we can break into two:

            For activities with a specific role: check both department and role.
            For activities without a specific role: check only department.

        We can do:

            (expected.expected_department IS NOT NULL AND r.department <> expected.expected_department)
            OR 
            (expected.expected_role IS NOT NULL AND r.role <> expected.expected_role)

        This will flag if the department is wrong for any activity, and if the role is wrong for activities that have an expected role.

    However, note that the same activity might be performed by multiple roles? But in the normal flow, we have a defined role.

  These are some initial queries to investigate the anomalies.

  Let's summarize the anomalies we found and the corresponding queries:

    Anomaly: Missing activities in a case (e.g., missing 'Validate Stock' in 1003 and 1004, missing 'Perform Credit Check' in 1004).

        Query: Use the CTE with expected_activities to find missing activities per case.

    Anomaly: Activities out of order:

        - Shipment before confirmation: Query with two joins for 'Ship Goods' and 'Confirm Shipment'
        - Payment before invoice: Query for 'Receive Payment' before 'Issue Invoice'
        - Credit check after shipment: Query for 'Perform Credit Check' after 'Ship Goods'
        - Stock validation after shipment: Query for 'Validate Stock' after 'Ship Goods'

    Anomaly: Confirm Shipment with shipment_scheduled=N and then shipped? Query to find such cases.

    Anomaly: Wrong role/department? Query to check the resource's role and department against expected.

  We might also want to see the distribution of anomalies per order type? So we can join with orders to get order_type.

  Example: For missing activities, we can do:

        WITH missing_activities AS (
            ... the CTE above that lists missing activities per case ...
        )
        SELECT 
            m.case_id,
            m.missing_activity,
            o.order_type
        FROM missing_activities m
        JOIN orders o ON m.case_id = o.case_id;

  Similarly for out-of-order events.

  We can also check if the anomalies are more frequent in a particular department? But that might be more advanced.

  Given the above, we have a set of queries to investigate the anomalies.

  Note: The above queries are just the starting point. The investigation might reveal more anomalies or require more specific queries.

  Let's write the SQL queries in the required format.

  However, note: the prompt asks to propose relevant SQL queries without any hints. So we just list the queries.

  We'll write the queries as described.

  Important: We are to write the queries that would be used to investigate the hypotheses. We don't run them here.

  Let's write them:

  Query 1: Find missing activities per case.

      WITH expected_activities AS (
          SELECT 
              cases.case_id,
              expected.activity
          FROM 
              (SELECT DISTINCT case_id FROM order_event_log) AS cases
          CROSS JOIN 
              (VALUES 
                  ('Register Order'),
                  ('Perform Credit Check'),
                  ('Validate Stock'),
                  ('Confirm Shipment'),
                  ('Ship Goods'),
                  ('Issue Invoice'),
                  ('Receive Payment')
              ) AS expected(activity)
      )
      SELECT 
          expected.case_id,
          expected.activity AS missing_activity
      FROM expected_activities expected
      LEFT JOIN order_event_log oel 
          ON expected.case_id = oel.case_id 
          AND expected.activity = oel.activity
      WHERE oel.case_id IS NULL;

  Query 2: Find cases where shipment occurred before confirmation.

      SELECT 
          o1.case_id
      FROM 
          order_event_log o1
      INNER JOIN 
          order_event_log o2 ON o1.case_id = o2.case_id
      WHERE 
          o1.activity = 'Ship Goods'
          AND o2.activity = 'Confirm Shipment'
          AND o1.timestamp < o2.timestamp;

  Query 3: Find cases where payment occurred before invoice.

      SELECT 
          o1.case_id
      FROM 
          order_event_log o1
      INNER JOIN 
          order_event_log o2 ON o1.case_id = o2.case_id
      WHERE 
          o1.activity = 'Receive Payment'
          AND o2.activity = 'Issue Invoice'
          AND o1.timestamp < o2.timestamp;

  Query 4: Find cases where credit check occurred after shipment.

      SELECT 
          o1.case_id
      FROM 
          order_event_log o1
      INNER JOIN 
          order_event_log o2 ON o1.case_id = o2.case_id
      WHERE 
          o1.activity = 'Perform Credit Check'
          AND o2.activity = 'Ship Goods'
          AND o1.timestamp > o2.timestamp;

  Query 5: Find cases where stock validation occurred after shipment.

      SELECT 
          o1.case_id
      FROM 
          order_event_log o1
      INNER JOIN 
          order_event_log o2 ON o1.case_id = o2.case_id
      WHERE 
          o1.activity = 'Validate Stock'
          AND o2.activity = 'Ship Goods'
          AND o1.timestamp > o2.timestamp;

  Query 6: Find cases where shipment was confirmed as not scheduled but then shipped.

      -- First, find confirmations with shipment_scheduled=N
      WITH confirmations AS (
          SELECT 
              case_id,
              timestamp AS conf_time
          FROM order_event_log
          WHERE activity = 'Confirm Shipment'
              AND additional_info LIKE '%shipment_scheduled=N%'
      )
      SELECT 
          c.case_id,
          s.timestamp AS ship_time
      FROM confirmations c
      INNER JOIN 
          order_event_log s ON c.case_id = s.case_id
      WHERE 
          s.activity = 'Ship Goods'
          AND s.timestamp > c.conf_time;

  Query 7: Check for activities performed by the wrong department or role.

      WITH expected AS (
          SELECT 
              'Register Order' AS activity, 
              'Sales' AS expected_department, 
              'Sales Executive' AS expected_role
          UNION ALL
          SELECT 
              'Perform Credit Check', 
              'Finance', 
              'Credit Analyst'
          UNION ALL
          SELECT 
              'Validate Stock', 
              'Logistics', 
              'Warehouse Staff'
          UNION ALL
          SELECT 
              'Confirm Shipment', 
              'Logistics', 
              'Logistics Manager'
          UNION ALL
          SELECT 
              'Ship Goods', 
              'Logistics', 
              'Warehouse Staff'
          UNION ALL
          SELECT 
              'Issue Invoice', 
              'Finance', 
              NULL
          UNION ALL
          SELECT 
              'Receive Payment', 
              'Finance', 
              NULL
      )
      SELECT 
          oel.case_id,
          oel.activity,
          oel.resource,
          r.department AS actual_department,
          r.role AS actual_role,
          expected.expected_department,
          expected.expected_role
      FROM order_event_log oel
      INNER JOIN resources r ON oel.resource = r.resource_id
      INNER JOIN expected ON oel.activity = expected.activity
      WHERE 
          (expected.expected_department IS NOT NULL AND r.department <> expected.expected_department)
          OR 
          (expected.expected_role IS NOT NULL AND r.role <> expected.expected_role);

  These queries should help in investigating the anomalies.

  Note: We might also want to see the entire sequence of events per case? That can be done by:

        SELECT 
            case_id,
            activity,
            timestamp,
            resource
        FROM order_event_log
        ORDER BY case_id, timestamp, event_id;

  But that is more for manual inspection.

  We have provided a set of targeted queries.

  Let me know if you need more.

</think>


### Identified Anomalies and Undesirable Behaviors

1. **Out-of-Order Activities**:
   - **Order 1002**: Shipment confirmed/shipped (events 9-10) **before** credit check (event 11) and stock validation (event 12).
   - **Order 1003**: Goods shipped (event 17) **before** shipment confirmation (event 19) and **missing** stock validation.
   - **Order 1004**: Payment received (event 22) **before** credit check, stock validation, and shipment confirmation (event 24).

2. **Missing Critical Activities**:
   - **Order 1003**: Missing `Validate Stock` activity.
   - **Order 1004**: Missing `Perform Credit Check` and `Validate Stock` activities.

3. **Illogical Process Sequences**:
   - **Order 1004**: `Confirm Shipment` marked as `shipment_scheduled=N` (not scheduled), yet goods were shipped (event 25).

4. **Post-Shipment Activities**:
   - **Order 1002**: Credit check (event 11) and stock validation (event 12) occurred **after** shipment (event 10).

---

### Hypotheses for Anomalies

1. **System Glitches/Integration Failures**:
   - Missing activities (e.g., stock validation in 1003/1004) may stem from failed service calls or timeouts during high load.

2. **Policy Violations/Manual Overrides**:
   - Early shipment in 1002/1003 could result from "rush orders" bypassing protocols. Post-hoc credit checks (1002) suggest reactive risk management.

3. **Process Gaps in High-Value/Priority Orders**:
   - Order 1004 (high-value) skipped credit checks, indicating potential gaps in handling prepayments or VIP customers.

4. **Data Entry Errors**:
   - `shipment_scheduled=N` followed by shipping (1004) may be a misconfiguration or user error in the confirmation UI.

5. **Training Issues**:
   - Resources may not follow the prescribed sequence (e.g., logistics staff shipping before validation in 1003).

---

### Proposed SQL Queries for Investigation

#### 1. **Identify Missing Activities**
```sql
WITH expected_activities AS (
  SELECT 
    o.case_id,
    a.activity
  FROM orders o
  CROSS JOIN (
    VALUES 
      ('Perform Credit Check'),
      ('Validate Stock')
  ) AS a(activity)
)
SELECT 
  e.case_id,
  e.activity AS missing_activity,
  o.order_type,
  o.order_value
FROM expected_activities e
LEFT JOIN order_event_log l 
  ON e.case_id = l.case_id 
  AND e.activity = l.activity
WHERE l.event_id IS NULL;
```

#### 2. **Detect Out-of-Order Activities**
```sql
SELECT 
  o1.case_id,
  o1.activity AS first_activity,
  o2.activity AS second_activity,
  o1.timestamp,
  o2.timestamp
FROM order_event_log o1
JOIN order_event_log o2 
  ON o1.case_id = o2.case_id
WHERE 
  (o1.activity = 'Ship Goods' AND o2.activity = 'Confirm Shipment' AND o1.timestamp < o2.timestamp)
  OR 
  (o1.activity = 'Perform Credit Check' AND o2.activity = 'Ship Goods' AND o1.timestamp > o2.timestamp)
  OR
  (o1.activity = 'Receive Payment' AND o2.activity = 'Issue Invoice' AND o1.timestamp < o2.timestamp);
```

#### 3. **Flag Illogical Shipments**
```sql
SELECT 
  o.case_id,
  o.order_value,
  l.activity,
  l.additional_info
FROM order_event_log l
JOIN orders o ON l.case_id = o.case_id
WHERE l.activity = 'Confirm Shipment'
  AND l.additional_info LIKE '%shipment_scheduled=N%'
  AND EXISTS (
    SELECT 1 
    FROM order_event_log s 
    WHERE s.case_id = l.case_id 
      AND s.activity = 'Ship Goods'
      AND s.timestamp > l.timestamp
  );
```

#### 4. **Check Resource Role/Department Mismatches**
```sql
SELECT 
  l.case_id,
  l.activity,
  r.role AS actual_role,
  r.department AS actual_department,
  CASE 
    WHEN l.activity IN ('Register Order') THEN 'Sales'
    WHEN l.activity IN ('Perform Credit Check', 'Issue Invoice', 'Receive Payment') THEN 'Finance'
    WHEN l.activity IN ('Validate Stock', 'Confirm Shipment', 'Ship Goods') THEN 'Logistics'
  END AS expected_department
FROM order_event_log l
JOIN resources r ON l.resource = r.resource_id
WHERE 
  (l.activity IN ('Register Order') AND r.department <> 'Sales')
  OR 
  (l.activity IN ('Perform Credit Check', 'Issue Invoice', 'Receive Payment') AND r.department <> 'Finance')
  OR 
  (l.activity IN ('Validate Stock', 'Confirm Shipment', 'Ship Goods') AND r.department <> 'Logistics');
```

#### 5. **Analyze Post-Shipment Activities**
```sql
SELECT 
  o.case_id,
  o.order_type,
  o.order_value,
  l.activity,
  l.timestamp
FROM order_event_log l
JOIN orders o ON l.case_id = o.case_id
WHERE l.timestamp > (
  SELECT MAX(timestamp) 
  FROM order_event_log 
  WHERE case_id = l.case_id 
    AND activity = 'Ship Goods'
)
AND l.activity IN ('Perform Credit Check', 'Validate Stock');
```

#### 6. **Correlate Anomalies with Order Value/Type**
```sql
SELECT 
  o.case_id,
  o.order_type,
  o.order_value,
  COUNT(DISTINCT CASE 
    WHEN l.activity IN ('Perform Credit Check', 'Validate Stock') THEN l.activity 
    END) AS missing_activities,
  MAX(CASE 
    WHEN l.activity = 'Ship Goods' THEN l.timestamp 
    END) AS ship_time,
  MAX(CASE 
    WHEN l.activity = 'Confirm Shipment' THEN l.timestamp 
    END) AS confirm_time
FROM orders o
LEFT JOIN order_event_log l ON o.case_id = l.case_id
GROUP BY o.case_id, o.order_type, o.order_value
HAVING 
  COUNT(DISTINCT CASE 
    WHEN l.activity IN ('Perform Credit Check', 'Validate Stock') THEN l.activity 
    END) < 2
  OR 
  MAX(CASE WHEN l.activity = 'Ship Goods' THEN l.timestamp END) 
    < MAX(CASE WHEN l.activity = 'Confirm Shipment' THEN l.timestamp END);
```

---

### Key Insights from Queries
1. **High-Value Orders At Risk**: Missing credit checks in high-value orders (e.g., 1004) could indicate inadequate risk assessment for large payments.
2. **Priority Order Vulnerabilities**: Rushed shipments (1002) suggest policies enabling priority orders to bypass validations.
3. **Department Silos**: Mismatched roles (e.g., Sales handling shipments) imply cross-departmental training gaps.
4. **System Reliability**: Missing activities may correlate with peak hours or integration failures between services. 

These queries enable root-cause analysis by combining process deviations, resource behavior, and order characteristics.