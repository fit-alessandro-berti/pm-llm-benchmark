<think>
Okay, let's break down the user's query. They want me to act as a prompt engineer crafting a detailed instruction for a Large Language Model (LLM) to analyze an order process log. The user provided a complex database schema with three tables: order_event_log, orders, and resources, along with sample data. The main goal is to identify anomalies in the event log, hypothesize their causes, and write SQL queries for further investigation.

First, I need to understand the process flow. The assumed steps are Register Order, Credit Check, Validate Stock, Confirm Shipment, Ship Goods, Issue Invoice, and Receive Payment. Each order should follow this sequence. The user provided three example orders, each with differing event logs. 

Looking at the sample data, I notice Order 1001 follows all steps. Order 1002 has a Complete Shipment before Credit Check, which is out of order. Order 1003 skips Confirm Shipment and starts Shipping right after Credit Check. Order 1004 skips Validate Stock and has Receive Payment immediately after Registration. These are clear sequence anomalies.

Next, hypothetical causes. Possible reasons for the incorrect sequence in 1002 could be a system error in scheduling. For 1003, maybe a manual override skipped the Confirm Shipment step. In 1004, missing Validate Stock might indicate a broken process or a quick payment without verification.

When writing the SQL queries, I should ensure they check for out-of-sequence events, missing steps, and resource involvement. Queries need to filter case_ids where certain events don't follow the expected order, check for missing events, and see if resources overlap points where steps should have been sequential. Also, using JOINs with resources and orders tables would add context, like checking if Confirm Shipment precedes Ship Goods and creating a resource table to ensure single resource per step.

The user wants the LLM to generate these queries without hints, so the prompt needs to clearly list the five behaviors to check (sequence, missing steps, short durations, resource overlaps, activity gaps) and specify the schema details. Including the step order and table relationships is crucial for the LLM to construct accurate SQL statements. Ensuring the prompt is thorough but not leading will help the LLM produce the required investigative queries independently.

</think>


**Prompt Engineering Output:**

**Target Model Instruction Set:**

1.  **Sequence Anomaly Detection:** Identify orders where any event does not succeed the directly preceding event in the *assumed normal sequence* (Register Order, Perform Credit Check, Validate Stock, Confirm Shipment, Ship Goods, Issue Invoice, Receive Payment). Hypothesize execution order deviations (e.g., missing steps, reversed steps, premature completion).
    *   *Query Strategy:* Use `CASE` statements or subquery comparisons (`LAG()`, `FOLLOWING` in PG16) or self-joins to check that *each* event_id > previous exists and that `activity` follows the expected sequence. Check `event_id` values for gaps or reversals *specifically within the expected activity order* per case_id.

2.  **Activity/Missing Gap Detection:** Identify orders where any critical step is entirely *absent* (no Registered Order, no Credit Check, etc.) or spans longer than x minutes between sequential critical steps (e.g., confirm shipment > ticket number given, receipt from payment check). Hypothesize delay/execution issues.
    *   *Query Strategy:* Filter for `activity` values that are explicitly missing from the critical sequence. Calculate time differences between critical consecutive events (`timestamp`) using `MAX()` or `LAG()` to find gaps > threshold.

3.  **Resource Overlap Anomaly Detection:** Identify orders where a *resource* participates in multiple events *without* the expected preceding event being completed (e.g., Ship Goods event recorded with no preceding Validate Stock event for that order, or a Resource performs Confirm Shipment and Receive Payment on the same day but Validate Stock is missing). Hypothesize authorization/execution errors.
    *   *Query Strategy:* Filter for case_ids where distinct resources appear with `activity` values that *precede* or *succeed* a critical missing step in their sequence within a short timeframe (e.g., Server resource 'Ship Goods' exists 2 minutes before 'Validate Stock' is first attempted). Use DISTINCT() to isolate resource-activity pairs.

4.  **Activity Duration Anomaly Detection:** Identify rapid-fire sequences (single user session) where critical steps occur with implausibly short durations (e.g., Validate Stock -> Ship Goods in < 5 minutes, Issue Invoice -> Receive Payment < 20 seconds). Hypothesize automation, multiple simultaneous sessions, or data entry errors.
    *   *Query Strategy:* Calculate difference (`MAX()` - `LAG()`) for `timestamp` between consecutive events sharing the same `resource` and appearing within a defined time window (< 5min/20sec). Flag extreme durations (negative or very small positive).

5.  **Activity Gap Behavior Detection:** Identify orders where the sequence shows a skip (missing step) but subsequent steps still occur (e.g., Order Registered, Credit Check done, but then Validate Stock is skipped and Ship Goods performed anyway). Hypothesize workaround bypasses.
    *   *Query Strategy:* Identify case_ids where a critical event (e.g., Validate Stock) is explicitly missing (`activity NOT IN (...critical steps...)`) but events *after* a predecessor critical event (e.g., Confirm Shipment) with the same resource (e.g., Warehouse Clerk) are present. Use `EXISTS` or `NOT EXISTS` with subqueries for gaps.

**Schema Reference for LLM:**

*   **`order_event_log`** (`case_id`, `event_id`, `activity`, `timestamp`, `resource`, `additional_info`)
*   **`orders`** (`case_id`, `customer_id`, `order_type`, `order_value`) (References `case_id`)
*   **`resources`** (`resource_id`, `role`, `department`) (`resource_id` FK to `order_event_log.resource`)

**Critical Steps Order (By Assumption):**  
`Register Order` -> `Perform Credit Check` -> `Validate Stock` -> `Confirm Shipment` -> `Ship Goods` -> `Issue Invoice` -> `Receive Payment`

**SQL Output Expectation:**  
The model should return only the **SQL query text** (or necessary `DELETE`/`UPDATE` commands if anomalies are found) along with its **expected behavior (hypothesized root cause)**. *No additional commentary or explanation beyond the query and its objective should be provided in the response to the LLM.*

**Example Query (Sequence Anomaly - Missing Confirm Shipment):**  
```sql
WITH ordered_steps AS (
  SELECT 
    cle.case_id,
    cle.event_id,
    cle.activity,
    cle.resource,
    cle.timestamp
  FROM order_event_log cle
  WHERE cle.case_id = 1003 AND cle.activity IN ('Confirm Shipment', 'Ship Goods')
  ORDER BY cle.event_id
),
sequence_check AS (
  SELECT 
    cws.case_id,
    cws.event_id,
    cws.activity,
    cws.resource,
    cws.timestamp,
    cws1.activity AS previous_activity
  FROM ordered_steps cws
  LEFT JOIN ordered_steps cws1 
    ON cws.case_id = cws1.case_id 
    AND cws1.event_id = (cws.event_id - 1)
)
SELECT * 
FROM sequence_check 
WHERE previous_activity IS NULL 
  AND activity = 'Ship Goods';
```