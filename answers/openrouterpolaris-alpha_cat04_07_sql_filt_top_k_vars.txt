Here is a concise DuckDB SQL solution that performs all requested steps. Replace :K with your desired top-K value.

WITH ordered_events AS (
    SELECT
        case_id,
        activity,
        timestamp
    FROM event_log
),
case_variants AS (
    SELECT
        case_id,
        -- Build the ordered activity sequence per case
        string_agg(activity, '->' ORDER BY timestamp) AS variant
    FROM ordered_events
    GROUP BY case_id
),
variant_counts AS (
    SELECT
        variant,
        COUNT(*) AS case_count
    FROM case_variants
    GROUP BY variant
),
top_k_variants AS (
    SELECT
        variant
    FROM variant_counts
    ORDER BY case_count DESC, variant
    LIMIT :K
),
top_k_cases AS (
    SELECT
        cv.case_id
    FROM case_variants cv
    JOIN top_k_variants tk
      ON cv.variant = tk.variant
)
SELECT
    e.*
FROM event_log e
JOIN top_k_cases c
  ON e.case_id = c.case_id
ORDER BY e.case_id, e.timestamp;