## DuckDB SQL Query: Filter Cases by Event Count

### Primary Solution (CTE Approach)

```sql
-- Step 1: Identify cases with 6 or fewer events
-- Step 2: Return all events belonging only to those cases
WITH case_event_counts AS (
    SELECT
        case_id,
        COUNT(*) AS event_count
    FROM event_log
    GROUP BY case_id
    HAVING COUNT(*) <= 6
)
SELECT
    el.*
FROM event_log AS el
INNER JOIN case_event_counts AS cec
    ON el.case_id = cec.case_id
ORDER BY
    el.case_id,
    el.timestamp;
```

---

### Alternative 1: Subquery with `IN`

```sql
SELECT *
FROM event_log
WHERE case_id IN (
    SELECT case_id
    FROM event_log
    GROUP BY case_id
    HAVING COUNT(*) <= 6
)
ORDER BY
    case_id,
    timestamp;
```

---

### Alternative 2: Window Function

```sql
SELECT
    case_id,
    activity,
    timestamp
FROM (
    SELECT
        *,
        COUNT(*) OVER (PARTITION BY case_id) AS event_count
    FROM event_log
) AS enriched
WHERE event_count <= 6
ORDER BY
    case_id,
    timestamp;
```

---

### Approach Comparison

| Approach | Readability | Performance Note |
|---|---|---|
| **CTE + JOIN** |  High | Explicit, optimizer-friendly |
| **Subquery + IN** |  High | Clean but `IN` can be slower on large sets |
| **Window Function** |  Medium | Single scan, but filters *after* full computation |

---

### Key Logic Breakdown

```
event_log

 GROUP BY case_id           count events per case
 HAVING COUNT(*) <= 6       keep only small cases
 JOIN back to event_log     retrieve full event rows
```

**The recommended CTE approach** is preferred for clarity and maintainability — it explicitly separates the *"which cases qualify"* logic from the *"retrieve events"* logic, making it easy to audit and modify the threshold (`<= 6`).