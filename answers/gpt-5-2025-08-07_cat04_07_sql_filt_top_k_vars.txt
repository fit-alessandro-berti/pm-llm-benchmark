-- Set K here (number of top variants to keep)
WITH params AS (
  SELECT 5 AS k
),
-- 1) Build the ordered activity sequence (variant) per case
case_variants AS (
  SELECT
    case_id,
    string_agg(activity, ' -> ' ORDER BY "timestamp", activity) AS variant
  FROM event_log
  GROUP BY case_id
),
-- 2) Count cases per variant
variant_counts AS (
  SELECT
    variant,
    COUNT(*) AS case_count
  FROM case_variants
  GROUP BY variant
),
-- 3) Pick the top K variants by frequency (break ties deterministically by variant)
top_variants AS (
  SELECT vc.variant
  FROM variant_counts vc, params p
  ORDER BY vc.case_count DESC, vc.variant
  LIMIT p.k
),
-- 4) Keep only cases that belong to the top K variants
selected_cases AS (
  SELECT cv.case_id
  FROM case_variants cv
  JOIN top_variants tv USING (variant)
)
-- 5) Return all events for those cases only
SELECT e.*
FROM event_log e
JOIN selected_cases sc USING (case_id)
ORDER BY e.case_id, e."timestamp";