**DuckDB SQL – return every event *except* the cases that contain the threestep pattern  
`Approve Purchase Requisition  Create Order  Confirm Order` (no other event inbetween) **and** where the time between *Create Order* and *Confirm Order* is larger than5days**

```sql
/* --------------------------------------------------------------
   1  Give every event a deterministic order inside its case
   -------------------------------------------------------------- */
WITH ordered AS (
    SELECT
        case_id,
        activity,
        timestamp,
        ROW_NUMBER() OVER (PARTITION BY case_id ORDER BY timestamp) AS rn
    FROM event_log
),

/* --------------------------------------------------------------
   2  Find the exact threerow succession inside a case
       (rows rn, rn+1, rn+2) and keep the cases that also satisfy
       the timing condition (> 5 days between the 2nd and 3rd rows)
   -------------------------------------------------------------- */
bad_cases AS (
    SELECT
        o1.case_id,
        o1.timestamp AS ts_approve,
        o2.timestamp AS ts_create,
        o3.timestamp AS ts_confirm
    FROM ordered o1
    JOIN ordered o2
          ON o2.case_id = o1.case_id
         AND o2.rn      = o1.rn + 1
    JOIN ordered o3
          ON o3.case_id = o1.case_id
         AND o3.rn      = o1.rn + 2
    WHERE o1.activity = 'Approve Purchase Requisition'
      AND o2.activity = 'Create Order'
      AND o3.activity = 'Confirm Order'
      AND o3.timestamp - o2.timestamp > INTERVAL '5' DAY   -- > 5 days
)

/* --------------------------------------------------------------
   3  Return everything that does **not** belong to a “bad” case
   -------------------------------------------------------------- */
SELECT *
FROM event_log
WHERE case_id NOT IN (SELECT DISTINCT case_id FROM bad_cases)
ORDER BY case_id, timestamp;          -- optional, just for readability
```

### How it works

| Step | What it does |
|------|--------------|
| **`ordered` CTE** | Assigns a row number (`rn`) to each event **per `case_id`** ordered by `timestamp`. This gives us a stable “position” inside each case. |
| **`bad_cases` CTE** | Joins three consecutive rows (`rn`, `rn+1`, `rn+2`) of the same case. The `WHERE` clause forces the three activities to be exactly the required sequence and checks that the time gap between the *Create Order* (`o2`) and *Confirm Order* (`o3`) rows is larger than 5 days. The result is a list of `case_id`s that must be filtered out. |
| **Final SELECT** | Retrieves every row from the original `event_log` **except** those whose `case_id` appears in `bad_cases`. The optional `ORDER BY` makes the output easier to inspect. |

The query works entirely inside DuckDB, uses only standard SQL constructs (window functions, CTEs, and `IN`/`NOT IN`), and returns **all events from cases that do *not* meet the specified sequenceandtiming condition**.