### Analysis of Anomalies and Undesirable Behaviors in the Event Log

Based on the provided event log data and schema, several anomalies and undesirable behaviors can be identified. Below, I’ll outline these issues, hypothesize potential causes, and propose SQL queries to investigate them further.

---

## **1. Skipping Steps in the Process**

### **Anomaly:**
In **case_id = 1004**, the sequence of activities is:
1. Register Order
2. **Receive Payment**
3. Issue Invoice
4. Confirm Shipment
5. Ship Goods

The **“Perform Credit Check”**, **“Validate Stock”** steps are **missing** before shipping and receiving payment.

### **Potential Causes:**
- **System bypass:** Automated workflows or manual overrides may allow orders to skip credit checks and stock validation.
- **Human error:** An operator may have manually recorded payment and shipment without completing required steps.
- **Incorrect logging:** The missing steps might have been logged incorrectly or not logged at all.

### **SQL Queries for Investigation:**

#### **A. Identify all cases where required activities are missing:**
```sql
WITH expected_activities AS (
    SELECT DISTINCT activity 
    FROM order_event_log 
    WHERE activity IN (
        'Register Order', 
        'Perform Credit Check', 
        'Validate Stock', 
        'Confirm Shipment', 
        'Ship Goods', 
        'Issue Invoice', 
        'Receive Payment'
    )
),
case_activities AS (
    SELECT 
        case_id,
        array_agg(activity ORDER BY event_id) AS activity_sequence
    FROM order_event_log
    GROUP BY case_id
)
SELECT 
    ce.case_id,
    ea.activity AS missing_activity,
    ce.activity_sequence
FROM case_activities ce
CROSS JOIN expected_activities ea
WHERE ea.activity NOT IN (SELECT unnest(ce.activity_sequence))
LIMIT 10;
```

#### **B. Find cases where “Receive Payment” occurs before “Issue Invoice”:**
```sql
SELECT 
    oel.case_id,
    oel.activity,
    oel.timestamp,
    oel.resource
FROM order_event_log oel
WHERE EXISTS (
    SELECT 1 
    FROM order_event_log oel2 
    WHERE oel2.case_id = oel.case_id 
        AND oel2.activity = 'Receive Payment' 
        AND oel2.event_id < oel.event_id 
        AND oel.activity = 'Issue Invoice'
);
```

#### **C. Join with orders to see if high-value orders are more likely to skip steps:**
```sql
SELECT 
    oel.case_id,
    o.order_value,
    oel.activity,
    oel.timestamp
FROM order_event_log oel
JOIN orders o ON oel.case_id = o.case_id
WHERE oel.case_id IN (
    SELECT case_id 
    FROM order_event_log 
    GROUP BY case_id 
    HAVING NOT EXISTS (
        SELECT 1 
        FROM order_event_log oel2 
        WHERE oel2.case_id = oel.case_id 
            AND oel2.activity = 'Perform Credit Check'
    )
);
```

---

## **2. Out-of-Order Execution**

### **Anomaly:**
In **case_id = 1003**, the sequence is:
1. Register Order
2. Perform Credit Check
3. **Ship Goods**
4. Issue Invoice
5. **Confirm Shipment**
6. Receive Payment

“Ship Goods” occurs **before** “Confirm Shipment”, which violates the assumed process flow.

### **Potential Causes:**
- **Data entry error:** The event IDs or timestamps might be incorrectly assigned.
- **Process exception:** Some orders may allow early shipping under special conditions.
- **Incorrect event ordering:** The event log may not reflect the true chronological order.

### **SQL Queries for Investigation:**

#### **A. Find all cases where “Ship Goods” occurs before “Confirm Shipment”:**
```sql
SELECT 
    case_id
FROM order_event_log
WHERE activity = 'Ship Goods'
AND EXISTS (
    SELECT 1 
    FROM order_event_log oel2 
    WHERE oel2.case_id = order_event_log.case_id 
        AND oel2.activity = 'Confirm Shipment' 
        AND oel2.event_id < order_event_log.event_id
);
```

#### **B. Check timestamps to verify chronological order:**
```sql
SELECT 
    oel.case_id,
    oel.activity,
    oel.timestamp,
    oel.resource
FROM order_event_log oel
WHERE oel.case_id IN (
    SELECT case_id 
    FROM order_event_log 
    WHERE activity = 'Ship Goods'
    AND EXISTS (
        SELECT 1 
        FROM order_event_log oel2 
        WHERE oel2.case_id = oel.case_id 
            AND oel2.activity = 'Confirm Shipment' 
            AND oel2.timestamp > oel.timestamp
    )
)
ORDER BY oel.case_id, oel.event_id;
```

#### **C. Check if this pattern is more common for certain resources or order types:**
```sql
SELECT 
    oel.resource,
    o.order_type,
    COUNT(*) AS out_of_order_cases
FROM order_event_log oel
JOIN orders o ON oel.case_id = o.case_id
WHERE oel.case_id IN (
    SELECT case_id 
    FROM order_event_log 
    WHERE activity = 'Ship Goods'
    AND EXISTS (
        SELECT 1 
        FROM order_event_log oel2 
        WHERE oel2.case_id = oel.case_id 
            AND oel2.activity = 'Confirm Shipment' 
            AND oel2.timestamp > oel.timestamp
    )
)
GROUP BY oel.resource, o.order_type;
```

---

## **3. Early Confirmation or Shipping**

### **Anomaly:**
In **case_id = 1002**, the sequence is:
1. Register Order
2. **Confirm Shipment**
3. Ship Goods
4. Perform Credit Check
5. Validate Stock
6. Issue Invoice
7. Receive Payment

“Confirm Shipment” and “Ship Goods” occur **before** “Perform Credit Check” and “Validate Stock”.

### **Potential Causes:**
- **Pre-emptive actions:** Warehouse or logistics may have started processing before finance completed credit checks.
- **Priority orders:** Certain order types (e.g., `priority`) may allow early shipment.
- **System or process misconfiguration:** The system may not enforce the correct sequence for all order types.

### **SQL Queries for Investigation:**

#### **A. Find all cases where “Confirm Shipment” occurs before “Perform Credit Check”:**
```sql
SELECT 
    case_id
FROM order_event_log
WHERE activity = 'Confirm Shipment'
AND EXISTS (
    SELECT 1 
    FROM order_event_log oel2 
    WHERE oel2.case_id = order_event_log.case_id 
        AND oel2.activity = 'Perform Credit Check' 
        AND oel2.event_id < order_event_log.event_id
);
```

#### **B. Check if this pattern is more common in `priority` orders:**
```sql
SELECT 
    o.order_type,
    COUNT(DISTINCT oel.case_id) AS early_shipment_cases
FROM order_event_log oel
JOIN orders o ON oel.case_id = o.case_id
WHERE oel.case_id IN (
    SELECT case_id 
    FROM order_event_log 
    WHERE activity = 'Confirm Shipment'
    AND EXISTS (
        SELECT 1 
        FROM order_event_log oel2 
        WHERE oel2.case_id = oel.case_id 
            AND oel2.activity = 'Perform Credit Check' 
            AND oel2.event_id < oel.event_id
    )
)
GROUP BY o.order_type;
```

#### **C. Examine resource involvement in early shipments:**
```sql
SELECT 
    oel.resource,
    COUNT(DISTINCT oel.case_id) AS early_shipment_cases
FROM order_event_log oel
WHERE oel.case_id IN (
    SELECT case_id 
    FROM order_event_log 
    WHERE activity = 'Confirm Shipment'
    AND EXISTS (
        SELECT 1 
        FROM order_event_log oel2 
        WHERE oel2.case_id = oel.case_id 
            AND oel2.activity = 'Perform Credit Check' 
            AND oel2.event_id < oel.event_id
    )
)
GROUP BY oel.resource;
```

---

## **4. Delayed Payment or Invoicing**

### **Anomaly:**
In **case_id = 1001**, “Receive Payment” occurs **4 days** after “Issue Invoice”.

In **case_id = 1003**, “Receive Payment” occurs **1 day** after “Issue Invoice”.

In **case_id = 1002**, “Receive Payment” occurs **1 day** after “Issue Invoice”.

In **case_id = 1004**, “Receive Payment” occurs **before** “Issue Invoice” — this is a **critical anomaly**.

### **Potential Causes:**
- **Normal variation:** Some orders may genuinely take longer to process payment.
- **Payment method:** Credit card, bank transfer, or check may influence processing time.
- **System error:** In case_id = 1004, payment may have been recorded prematurely.
- **Fraud or bad debt:** Long delays may indicate potential fraud or inability to pay.

### **SQL Queries for Investigation:**

#### **A. Calculate time between “Issue Invoice” and “Receive Payment” for each case:**
```sql
SELECT 
    oel1.case_id,
    oel1.timestamp AS invoice_time,
    oel2.timestamp AS payment_time,
    EXTRACT(EPOCH FROM (oel2.timestamp - oel1.timestamp)) / 3600 AS hours_between,
    oel1.resource AS invoice_resource,
    oel2.resource AS payment_resource
FROM order_event_log oel1
JOIN order_event_log oel2 
    ON oel1.case_id = oel2.case_id 
    AND oel1.activity = 'Issue Invoice' 
    AND oel2.activity = 'Receive Payment'
ORDER BY hours_between DESC;
```

#### **B. Identify cases where payment occurs before invoice:**
```sql
SELECT 
    oel1.case_id,
    oel1.activity,
    oel1.timestamp,
    oel2.activity,
    oel2.timestamp
FROM order_event_log oel1
JOIN order_event_log oel2 
    ON oel1.case_id = oel2.case_id 
    AND oel1.activity = 'Receive Payment' 
    AND oel2.activity = 'Issue Invoice' 
    AND oel1.timestamp < oel2.timestamp;
```

#### **C. Join with orders to see if high-value orders have longer payment times:**
```sql
SELECT 
    o.order_value,
    oel1.timestamp AS invoice_time,
    oel2.timestamp AS payment_time,
    EXTRACT(DAY FROM (oel2.timestamp - oel1.timestamp)) AS days_between
FROM order_event_log oel1
JOIN order_event_log oel2 
    ON oel1.case_id = oel2.case_id 
    AND oel1.activity = 'Issue Invoice' 
    AND oel2.activity = 'Receive Payment'
JOIN orders o ON oel1.case_id = o.case_id
ORDER BY days_between DESC;
```

---

## **5. Multiple Shipments or Invoices for a Single Order**

### **Anomaly:**
While not present in the current sample, it’s worth checking whether any `case_id` has **multiple** “Ship Goods” or “Issue Invoice” events, which could indicate duplicate processing or errors.

### **SQL Queries for Investigation:**

#### **A. Find cases with more than one “Ship Goods” event:**
```sql
SELECT 
    case_id,
    COUNT(*) AS ship_count
FROM order_event_log
WHERE activity = 'Ship Goods'
GROUP BY case_id
HAVING COUNT(*) > 1;
```

#### **B. Find cases with more than one “Issue Invoice” event:**
```sql
SELECT 
    case_id,
    COUNT(*) AS invoice_count
FROM order_event_log
WHERE activity = 'Issue Invoice'
GROUP BY case_id
HAVING COUNT(*) > 1;
```

---

## **Conclusion**

These anomalies suggest potential issues such as:

- **Process violations** (e.g., skipping credit checks or shipping before confirmation)
- **Data entry errors** (e.g., out-of-order events or duplicate entries)
- **System misconfigurations** (e.g., allowing payment before invoice)
- **Operational inefficiencies** (e.g., delayed payments)

The proposed SQL queries will help investigate these issues systematically and provide insights for process improvement, system validation, or data cleansing.