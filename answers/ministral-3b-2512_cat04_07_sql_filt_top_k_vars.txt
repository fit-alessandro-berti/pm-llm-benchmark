# DuckDB Query for Process Variant Analysis

Here's a comprehensive solution that addresses all your requirements:

```sql
WITH
-- Step 1: Get the ordered sequence of activities for each case_id
case_sequences AS (
    SELECT
        case_id,
        STRING_AGG(activity, '|') AS activity_sequence
    FROM event_log
    GROUP BY case_id
    ORDER BY case_id
),

-- Step 2: Count occurrences of each variant
variant_counts AS (
    SELECT
        activity_sequence,
        COUNT(*) AS case_count
    FROM case_sequences
    GROUP BY activity_sequence
    ORDER BY case_count DESC
),

-- Step 3: Get top K variants
top_variants AS (
    SELECT
        activity_sequence
    FROM variant_counts
    LIMIT 10  -- Adjust K as needed
),

-- Step 4: Filter cases to only those in top variants
filtered_cases AS (
    SELECT DISTINCT case_id
    FROM case_sequences
    WHERE activity_sequence IN (SELECT activity_sequence FROM top_variants)
)

-- Final result: All events from cases in top variants
SELECT
    e.*
FROM event_log e
JOIN filtered_cases fc ON e.case_id = fc.case_id
ORDER BY e.case_id, e.timestamp;
```

## Explanation:

1. **case_sequences CTE**:
   - Groups events by case_id and orders them by timestamp (implicitly through GROUP BY)
   - Uses STRING_AGG with a delimiter ('|') to create a compact sequence representation

2. **variant_counts CTE**:
   - Counts how many times each activity sequence appears
   - Orders results by frequency (descending)

3. **top_variants CTE**:
   - Selects the top K most frequent variants (adjust 10 to your desired K value)

4. **filtered_cases CTE**:
   - Identifies all case_ids that belong to the top variants

5. **Final query**:
   - Returns all original events from cases that are part of the top variants
   - Maintains the original timestamp ordering within each case

## Notes:

- The query assumes you want to see all events from cases in the top variants, not just the first few activities
- If you need to handle cases with empty sequences differently, you might want to add a check for NULL sequences
- For very large datasets, you might want to consider materializing intermediate results or using window functions for more efficient processing
- The delimiter '|' in STRING_AGG can be changed to any separator that won't appear in your activity names