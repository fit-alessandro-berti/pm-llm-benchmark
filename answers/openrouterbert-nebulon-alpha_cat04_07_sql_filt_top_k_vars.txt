# DuckDB SQL Query for Process Variant Analysis

Here's a comprehensive solution that addresses all requirements in a single query:

```sql
WITH
-- Step 1: Create ordered activity sequences for each case
activity_sequences AS (
    SELECT
        case_id,
        STRING_AGG(activity, ' > ' ORDER BY timestamp) AS variant
    FROM event_log
    GROUP BY case_id
),

-- Step 2: Count cases per variant and rank them
variant_counts AS (
    SELECT
        variant,
        COUNT(*) AS case_count,
        RANK() OVER (ORDER BY COUNT(*) DESC) AS frequency_rank
    FROM activity_sequences
    GROUP BY variant
),

-- Step 3: Identify top K variants (replace 5 with your desired K value)
top_variants AS (
    SELECT variant
    FROM variant_counts
    WHERE frequency_rank <= 5  -- Change this value to adjust K
),

-- Step 4: Get all events from cases in top variants
filtered_events AS (
    SELECT e.*
    FROM event_log e
    JOIN activity_sequences a ON e.case_id = a.case_id
    JOIN top_variants t ON a.variant = t.variant
)

-- Final result: All events from top K variant cases
SELECT * FROM filtered_events
ORDER BY case_id, timestamp;
```

## Explanation:

1. **activity_sequences**: This CTE creates the process variants by:
   - Grouping events by case_id
   - Concatenating activities in timestamp order with ' > ' as separator

2. **variant_counts**: This CTE:
   - Counts how many cases share each variant
   - Ranks variants by their frequency (most common first)

3. **top_variants**: Filters to keep only the top K variants (default K=5)

4. **filtered_events**: Joins back to the original event log to:
   - Include only events from cases that match the top K variants
   - Preserve all original columns and data

## Customization:

- To change the number of top variants (K), modify the value in the `WHERE frequency_rank <= 5` condition
- To change the variant separator, modify the ' > ' string in the STRING_AGG function
- The final result maintains all original columns from the event log for the filtered cases

This query efficiently handles all requirements while leveraging DuckDB's powerful SQL capabilities.