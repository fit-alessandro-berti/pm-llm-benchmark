# DuckDB SQL Query for Top K Process Variants

## Solution Overview

This query extracts process variants, ranks them by frequency, and returns events belonging only to the top K most common variants.

## Complete Query

```sql
WITH 
-- Step 1: Build the ordered activity sequence (variant) for each case
case_variants AS (
    SELECT 
        case_id,
        STRING_AGG(activity, ' -> ' ORDER BY timestamp) AS variant
    FROM event_log
    GROUP BY case_id
),

-- Step 2 & 3: Aggregate cases by variant and rank by frequency, keeping top K
top_k_variants AS (
    SELECT 
        variant,
        COUNT(*) AS case_count
    FROM case_variants
    GROUP BY variant
    ORDER BY case_count DESC
    LIMIT 5  -- Replace with desired K value
),

-- Step 4a: Identify case_ids belonging to top K variants
filtered_cases AS (
    SELECT cv.case_id
    FROM case_variants cv
    INNER JOIN top_k_variants tkv 
        ON cv.variant = tkv.variant
)

-- Step 4b: Return all events from the filtered cases
SELECT el.*
FROM event_log el
INNER JOIN filtered_cases fc 
    ON el.case_id = fc.case_id
ORDER BY el.case_id, el.timestamp;
```

## Query Breakdown

```

                         event_log                               
              (case_id, activity, timestamp)                     

                          
                          

   CTE 1: case_variants                                          
   - Groups events by case_id                                    
   - STRING_AGG orders activities by timestamp                   
   - Output: (case_id, variant)                                  

                          
                          

   CTE 2: top_k_variants                                         
   - Counts cases per variant                                    
   - Orders by frequency (descending)                            
   - Limits to top K variants                                    
   - Output: (variant, case_count)                               

                          
                          

   CTE 3: filtered_cases                                         
   - Joins case_variants with top_k_variants                     
   - Keeps only case_ids matching top K variants                 
   - Output: (case_id)                                           

                          
                          

   Final SELECT                                                  
   - Joins original event_log with filtered_cases                
   - Returns all events for cases in top K variants              

```

## Alternative: Using LIST() for Variant Representation

For more robust variant comparison (avoids delimiter conflicts):

```sql
WITH 
case_variants AS (
    SELECT 
        case_id,
        LIST(activity ORDER BY timestamp) AS variant  -- Returns array type
    FROM event_log
    GROUP BY case_id
),

top_k_variants AS (
    SELECT 
        variant,
        COUNT(*) AS case_count
    FROM case_variants
    GROUP BY variant
    ORDER BY case_count DESC
    LIMIT 5  -- K value
),

filtered_cases AS (
    SELECT cv.case_id
    FROM case_variants cv
    WHERE cv.variant IN (SELECT variant FROM top_k_variants)
)

SELECT el.*
FROM event_log el
WHERE el.case_id IN (SELECT case_id FROM filtered_cases)
ORDER BY el.case_id, el.timestamp;
```

## Key Points

| Aspect | Implementation |
|--------|----------------|
| **Sequence Ordering** | `ORDER BY timestamp` within aggregation |
| **Variant Representation** | `STRING_AGG()` or `LIST()` |
| **Variant Counting** | `GROUP BY variant` + `COUNT(*)` |
| **Top K Selection** | `ORDER BY case_count DESC LIMIT K` |
| **Final Filtering** | `INNER JOIN` on case_id |

## Parameterized Version (with K as variable)

```sql
-- Set K value
SET VARIABLE k_value = 5;

WITH 
case_variants AS (
    SELECT 
        case_id,
        STRING_AGG(activity, ' -> ' ORDER BY timestamp) AS variant
    FROM event_log
    GROUP BY case_id
),

ranked_variants AS (
    SELECT 
        variant,
        COUNT(*) AS case_count,
        DENSE_RANK() OVER (ORDER BY COUNT(*) DESC) AS rank
    FROM case_variants
    GROUP BY variant
),

filtered_cases AS (
    SELECT cv.case_id
    FROM case_variants cv
    INNER JOIN ranked_variants rv 
        ON cv.variant = rv.variant
    WHERE rv.rank <= getvariable('k_value')
)

SELECT el.*
FROM event_log el
INNER JOIN filtered_cases fc ON el.case_id = fc.case_id
ORDER BY el.case_id, el.timestamp;
```